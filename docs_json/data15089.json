{"add": {"doc": {"field": [{"@name": "docid", "#text": "BR-TU.18343"}, {"@name": "filename", "#text": "25250_ulfc118679_tm_Vanessa_Pita.pdf"}, {"@name": "filetype", "#text": "PDF"}, {"@name": "text", "#text": "UNIVERSIDADE DE LISBOA \n\nFACULDADE DE CI\u00caNCIAS \n\nDEPARTAMENTO DE F\u00cdSICA \n\n \n\n \n\n \n\n \n\n \n\nMonte Carlo LINAC Simulations using PRIMO \n\nfor IMRT Treatment Verification \n\n \n\nMestrado Integrado em Engenharia Biom\u00e9dica e Biof\u00edsica \n\nPerfil de Radia\u00e7\u00f5es em Diagn\u00f3stico e Terapia \n\n \n\nVanessa Cristina In\u00e1cio Pita \n\n \n\nDisserta\u00e7\u00e3o orientada por: \n\nProfessor Doutor Jo\u00e3o Miranda Santos \n\nProfessor Doutor Lu\u00eds Filipe Peralta \n\n \n\n \n\n2016\n\n\n\ni \n \n\nAcknowledgments \n \n\nThe realization of this project was an achievement to my professional life as much as \n\nit was an experience for my personal life. I would like to express my sincere gratitude to all of \n\nthose who made it possible and helped me to overcome all the adversities. \n\nDr. Jo\u00e3o Santos, I would like to thank you for the opportunity to join me in Medical \n\nPhysics, Radiobiology and Radiation Protection Group, in Porto IPO Research Center (CI-IPO); \n\nand also  for guiding me in this project, being always available and motivating me with your \n\nenthusiasm for this subject.  \n\nDr. Anabela Dias, thank you for the supervision provided in partnership with Dr. Jo\u00e3o \n\nand for all the help given. \n\nAlessandro, the huge knowledge in Monte Carlo and your ideas were an asset for this \n\nwork. Thank you so much for sharing them with me and for always making things look simpler \n\nthan I figured.  \n\nBruno, F\u00e1bio, Filipa, Filipe, Rafael, Rita, Susana, e Vera, ex- interns of the service and \n\nfrequent presence in laboratory 2, a big thank you to everyone. Without you my adaptation \n\nprocess to IPO would have not been so easy. Thank you for the affection, for the concern and \n\nfor the friendship and all the good moments we shared, I will never forget each of you. \n\nDra Joana, Diana, Sofia and all the Medical Physics Department of Porto IPO, with no \n\nexception, you were incredible to me. Thank you for your friendliness, for always being very \n\nhelpful to me, and for welcoming me so openly. \n\nProfessor Luis Peralta, I am thankful to you for being my internal supervisor and also \n\nfor your availability and concern. \n\nSofia, S\u00edlvia, Raquel and D\u00e9bora, my dear friends, thank you very much for your \n\nregular presence in my life in Porto and for always being with me. \n\nMy dear F\u00e1bio, your strength and unconditional support in the final phase of this \n\nproject was crucial to me. Therefore, an enormous \u201cthank you\u201d for always believed in me. \n\nIrene, Paulo, Jo\u00e3o and my whole family, I have no words to express my gratitude to \n\nyou, for all you have done for me. Without your support, none of this would have been \n\npossible. \n\n  \n\n\n\nii \n \n\nResumo \n \n\nAs simula\u00e7\u00f5es de Monte Carlo s\u00e3o consideradas o m\u00e9todo mais eficiente para \n\nexecutar c\u00e1lculos de dose absorvida em radioterapia externa, porque fornecem uma descri\u00e7\u00e3o \n\nmuito detalhada e completa dos campos de radia\u00e7\u00e3o e do transporte de part\u00edculas nos tecidos. \n\nExistem atualmente v\u00e1rios c\u00f3digos de Monte Carlo neste contexto, mas este trabalho focar-se-\n\n\u00e1 no PRIMO. O principal objetivo com o desenvolvimento deste projeto \u00e9 mostrar que o \n\nPRIMO \u00e9 uma ferramenta com enorme potencial para simular tratamentos de IMRT, e que por \n\nesta raz\u00e3o pode ser muito \u00fatil na verifica\u00e7\u00e3o cl\u00ednica destes tratamentos. \n\nA radioterapia de intensidade modulada (IMRT, do ingl\u00eas Intensity-Modulated \n\nRadiation Therapy), resulta da evolu\u00e7\u00e3o da t\u00e9cnica de radioterapia conformacional \n\ntridimensional (3D-CRT, do ingl\u00eas Three-Dimensional Conformal Radiotherapy). Esta veio \n\nacrescentar \u00e0 conforma\u00e7\u00e3o geom\u00e9trica do feixe de radia\u00e7\u00e3o, a capacidade de modula\u00e7\u00e3o da \n\nintensidade do mesmo. Por ser extremamente precisa a aplica\u00e7\u00e3o de um feixe de radia\u00e7\u00e3o \n\nnesta t\u00e9cnica, \u00e9 poss\u00edvel aplicarem-se elevadas doses de radia\u00e7\u00e3o ao tumor, preservando ao \n\nm\u00e1ximo os tecidos saud\u00e1veis. Contudo, esta t\u00e9cnica requer um planeamento mais complexo e \n\num maior n\u00famero de profissionais envolvidos desde o planeamento at\u00e9 \u00e0 execu\u00e7\u00e3o do \n\ntratamento.  \n\nAntes de ser efetuado um tratamento de IMRT \u00e9 necess\u00e1rio fazer uma verifica\u00e7\u00e3o \n\nprecisa da dose que ser\u00e1 administrada ao paciente, recorrendo a ferramentas de garantia do \n\ncontrolo da qualidade. Com estas, s\u00e3o comparadas as distribui\u00e7\u00f5es de dose adquiridas com um \n\nfant\u00f4ma com as simuladas no sistema de planeamento do tratamento. Para que o tratamento \n\nseja aplicado a um paciente, \u00e9 necess\u00e1rio que a compatibilidade seja superior a 95%, utilizando \n\num \u00edndice gama a 3% e 3mm, o que n\u00e3o ocorre sempre. Quando este n\u00edvel de concord\u00e2ncia \n\nn\u00e3o \u00e9 atingido \u00e9 necess\u00e1rio analisar o que influenciou esse resultado, e por vezes refazer o \n\nplano de tratamento, sem que grandes conclus\u00f5es acerca desta n\u00e3o concord\u00e2ncia sejam \n\napontadas. Uma vez que, para realizar estes testes, \u00e9 utilizada uma matriz com v\u00e1rias c\u00e2maras \n\nde ioniza\u00e7\u00e3o separadas entre si, neste caso em concreto, uma matriz com 729 c\u00e2maras de \n\nioniza\u00e7\u00e3o separadas por 1 cm, \u00e9 associado a esta medi\u00e7\u00e3o um dado erro. Este erro poder\u00e1 \n\nestar, por vezes, na origem da n\u00e3o concord\u00e2ncia entre o planeamento efetuado e a sua \n\nirradia\u00e7\u00e3o num fantoma. Por esta raz\u00e3o, nestas situa\u00e7\u00f5es, seria interessante a exist\u00eancia de \n\num m\u00e9todo alternativo de teste para contrapor estes resultados, como por exemplo aqueles \n\nque t\u00eam por base os c\u00e1lculos de Monte Carlo, tal como \u00e9 o caso do PRIMO. \n\nO PRIMO \u00e9 um programa de simula\u00e7\u00f5es de Monte Carlo, que tem por base o c\u00f3digo \n\nPENELOPE. Este permite que sejam calculadas distribui\u00e7\u00f5es de dose em fant\u00f4mas ou num \n\n\n\niii \n \n\npaciente, com a precis\u00e3o caracter\u00edstica dos m\u00e9todos de Monte Carlo. Contudo, contrariamente \n\nao que acontece com a maioria dos programas de Monte Carlo, o PRIMO apresenta a \n\nparticularidade de ter uma interface gr\u00e1fica muito apelativa ao utilizador, sendo muito \n\nintuitivo, e por isso de f\u00e1cil utiliza\u00e7\u00e3o. Este programa permite escolher o acelerador linear a \n\nutilizar, recorrendo a uma base de dados disponibilizada pela IAEA, e definir muitos outros \n\nfatores (energia nominal, SSD, tamanho do campo, etc.), tal como ocorre aquando de uma \n\naquisi\u00e7\u00e3o de distribui\u00e7\u00f5es de dose num fant\u00f4ma. \u00c9 por este motivo, que se acredita que este \n\nprograma poder\u00e1 ser um \u00f3timo complemento \u00e0 verifica\u00e7\u00e3o e aprova\u00e7\u00e3o de tratamentos de \n\nIMRT, tendo sido esta raz\u00e3o pela qual o programa foi escolhido para realizar este trabalho.  \n\nTratando-se de um programa bastante recente, a primeira etapa deste trabalho \n\nconsistiu na valida\u00e7\u00e3o do mesmo para os aceleradores utilizados. Este processo consistiu na \n\ncompara\u00e7\u00e3o das curvas de dosimetria b\u00e1sica: o perfil que mostra a percentagem de dose em \n\nprofundidade (PDD, do ingl\u00eas Percentage Depth Dose), e ainda os perfis transversais X e Y.  \n\nNa pr\u00e1tica, estas curvas s\u00e3o medidas diretamente num LINAC, utilizando um tanque de \n\n\u00e1gua para a sua aquisi\u00e7\u00e3o e os seus resultados foram usados para a compara\u00e7\u00e3o com os dados \n\nsimulados. Esta medi\u00e7\u00e3o \u00e9 efetuada a cada 6 meses (ou sempre que haja interven\u00e7\u00f5es no \n\nacelerador que as justifiquem), no sentido de verificar se as curvas medidas se encontram \n\ndentro dos par\u00e2metros aceit\u00e1veis, por compara\u00e7\u00e3o \u00e0s curvas obtidas aquando da instala\u00e7\u00e3o do \n\nLINAC e sua consequente aceita\u00e7\u00e3o (processo designado comummente por commissioning). \n\nPara escolher as curvas a usar na valida\u00e7\u00e3o do programa, foi realizado um estudo sobre a sua \n\nevolu\u00e7\u00e3o ao longo do tempo, que resultou na escolha do PDD e perfis laterais obtidos na \n\naceita\u00e7\u00e3o do aparelho.  \n\nNo PRIMO, estas curvas foram simuladas, para o mesmo aparelho utilizado nas \n\nmedi\u00e7\u00f5es pr\u00e1ticas, num fantoma equivalente ao tanque de \u00e1gua, j\u00e1 existente no programa. O \n\nLINAC escolhido para este estudo foi um CLINAC 2300 da Varian, por ser um aparelho existente \n\nno servi\u00e7o de Radioterapia do IPO do Porto e tamb\u00e9m no PRIMO. A valida\u00e7\u00e3o foi um processo \n\nefetuado por tentativa e erro. A cada simula\u00e7\u00e3o se alterava um dado par\u00e2metro (energia \n\ninicial, focal spot, t\u00e9cnica de redu\u00e7\u00e3o da vari\u00e2ncia, etc.). Quando terminava a simula\u00e7\u00e3o, o PDD \n\ne perfis laterais eram comparados com as curvas j\u00e1 selecionadas. Se os resultados n\u00e3o \n\napresentassem um grau de concord\u00e2ncia de 95% ou mais, segundo o \u00edndice gama a 2% e 2mm, \n\nalterava-se um par\u00e2metro e refazia-se a simula\u00e7\u00e3o. Quando os resultados simulados \n\napresentaram boa concord\u00e2ncia, o programa foi validado e o trabalho prosseguiu, rumo ao seu \n\nobjetivo final. Relativamente a este m\u00e9todo de compara\u00e7\u00e3o, \u00e9 pertinente referir que este \n\n\u00edndice gama \u00e9 o crit\u00e9rio de compara\u00e7\u00e3o tamb\u00e9m utilizado na pr\u00e1tica cl\u00ednica, embora nesse \n\ncontexto se use o \u00edndice gama para 3% e 3 mm. \n\n\n\niv \n \n\nA compara\u00e7\u00e3o das curvas de dosimetria b\u00e1sica simuladas e medidas foi realizada \n\ndiretamente no PRIMO, nesta etapa inicial. Contudo, para se poder progredir neste trabalho \n\nseria necess\u00e1rio comparar imagens e n\u00e3o curvas, isto \u00e9 comparar distribui\u00e7\u00f5es de dose 2D/3D \n\nem vez de 1D, o que n\u00e3o \u00e9 poss\u00edvel usando o PRIMO. Por esta raz\u00e3o, os resultados obtidos nas \n\nsimula\u00e7\u00f5es com o PRIMO tiveram de ser exportados e transformados em imagens DICOM, com \n\no aux\u00edlio de fun\u00e7\u00f5es criadas utilizando o Matlab, para que se pudesse realizar as compara\u00e7\u00f5es \n\nutilizando outro programa. O programa mais usado neste contexto foi o Verisoft, que \u00e9 o \n\nprograma utilizado nas compara\u00e7\u00f5es efetuadas aquando da verifica\u00e7\u00e3o dos tratamentos de \n\nIMRT. \n\nA segunda etapa consistiu na adi\u00e7\u00e3o do MLC aos campos simulados e, na sua \n\nconsequente, valida\u00e7\u00e3o. Para isso, foi simulado um campo 10x10 cm\n2\n com um MLC est\u00e1tico \n\ntendo uma dada conforma\u00e7\u00e3o. Esse campo simulado pelo PRIMO foi comparado com o mesmo \n\ncampo simulado pelo TPS, e tamb\u00e9m com o mesmo campo irradiado no LINAC. No final, as tr\u00eas \n\nmodalidades foram comparadas entre si e todas tinham de ser compat\u00edveis, segundo os \n\nmesmos crit\u00e9rios de compara\u00e7\u00e3o do \u00edndice gama. Quando essa compatibilidade foi \n\nencontrada, considerou-se o MLC validado e passou-se \u00e0 fase seguinte.  \n\nO \u00faltimo passo neste projeto foi a simula\u00e7\u00e3o de um campo 10x10 cm\n2\n com MLC \n\ndin\u00e2mico. Este passo \u00e9 equivalente a fazer a simula\u00e7\u00e3o de um campo de IMRT na t\u00e9cnica que \n\nutiliza o MLC por segmentos. Nesta fase foi preciso compilar 89 campos que, no final, \n\nperfizeram um campo de IMRT. Esse campo simulado foi, \u00e0 semelhan\u00e7a do ocorrido \n\nanteriormente, comparado tamb\u00e9m com a sua simula\u00e7\u00e3o pelo TPS e irradia\u00e7\u00e3o no LINAC. Uma \n\nvez verificada uma compatibilidade de 96% entre o campo simulado e medido, para um \u00edndice \n\ngama a 2% e 2mm, ficou demonstrada a potencialidade do programa para simular tratamentos \n\nde IMRT usando simula\u00e7\u00f5es de Monte Carlo. \n\nEste projeto foi um estudo preliminar \u00e0 simula\u00e7\u00e3o de tratamentos de IMRT usando o \n\nPRIMO, no qual, no final, se conseguiu simular um plano de IMRT com sucesso, pois este \n\napresentou uma concord\u00e2ncia aceit\u00e1vel com os resultados experimentais. Apesar de este \n\ntrabalho ter muito por onde ser continuado, pois estudos mais aprofundados sobre os \n\ntratamentos mais complexos s\u00e3o necess\u00e1rios, os resultados corroboram a tese de o PRIMO ser \n\numa ferramenta muito promissora para a simula\u00e7\u00e3o de tratamentos de IMRT em ambiente \n\ncl\u00ednico, em especial na garantia de qualidade dos mesmos. \n\n \n\nPalavras-chave: Radioterapia; IMRT; Simula\u00e7\u00f5es de Monte Carlo; PRIMO; Teste do \u00edndice \n\ngama.  \n\n\n\nv \n \n\nAbstract \n \n\nMonte Carlo (MC) approach is considered the gold standard method to perform \n\nabsorbed dose calculations in external radiotherapy because it provides the most detailed and \n\ncomplete description of radiation fields and particle transport in tissues. Several codes are \n\navailable and recently a new MC Penelope based code and graphic platform named PRIMO \n\nwas developed. PRIMO has a user-friendly approach, a suitable and competitive characteristic \n\nfor clinical activity. Nevertheless, advanced features such as Intensity Modulated Radiotherapy \n\n(IMRT) are not introduced yet. The aim of this work is to have a preliminary result on the \n\nfeasibility of MC simulation of IMRT procedures, making use of the PRIMO software, showing \n\nthat it can be an useful tool in clinical verification of IMRT treatments. \n\nThe first stage of this work was PRIMO validation for a Varian Clinac 2300, the same \n\nLINAC model used in practical acquisitions. This process consisted in comparing basic \n\ndosimetry curves acquired on LINAC using water tank with PRIMO simulations of them. Once \n\nPercentage Depth Dose (PDD) and lateral profiles X and Y simulated and acquired in practice \n\nshowed compatibility higher than 95%, using the gamma index criteria with 2% and 2mm, the \n\nprogram is validated. \n\nAfter validation, Multileaf Collimator (MLC) was added and validated. To achieve this \n\ngoal, a 10x10 cm\n2\n field with a static MLC with a given conformation was simulated. This field \n\nsimulated by PRIMO was compared to the same field simulated by the TPS, and also with the \n\nsame field irradiated on LINAC. In the end, the three methods were compared and all had to \n\nbe compatible, according to the same gamma index comparison criteria. When this \n\ncompatibility was found, MLC was validated and the work could proceed to the next stage. \n\nThe last step in this project was the simulation of a 10x10 cm\n2\n field with dynamic \n\nMLC. At this stage it was necessary to build 89 fields that in the end, their sum make one IMRT \n\nfield. As it had happened before, this simulated field was also compared with its simulation by \n\nTPS and its irradiation on LINAC. The compatibility between them was checked using the \n\ngamma index criteria of 2% and 2mm and it was found that 96% of the points were coincident. \n\nThis fact demonstrated PRIMO capability to simulate IMRT treatments and consequently, IMRT \n\ntreatments verification. \n\n \n\nKey words: Radiotherapy; IMRT; Monte Carlo Simulations; PRIMO; Gamma Index test. \n\n  \n\n\n\nvi \n \n\nList of Communications \n \n\nResulting from the work presented in this thesis a communication was presented in one of the \n\nmost important conferences in radiotherapy around the world, organized by the European \n\nSociety for Radiotherapy &amp; Oncology (ESTRO), the ESTRO 35. Bellow is the communication \n\nbibliographic reference: \n\n \n\n? V. Pita, A. Esposito, A.G.Dias, J. Lencart, J.A.M. Santos, \u201cPRIMO software as a tool for \n\nMonte Carlo treatment quality control in IMRT: a preliminary study\u201d, poster \n\npresentation in ESTRO 35, Turin, Italy, April 2016.  \n\n \n\n  \n\n\n\nvii \n \n\nAcronyms \n  \n\nAAA Anisotropic Analytical Algorithm \n\nCT Computed Tomography \n\nCTV Clinical Tumor Volume \n\nDCS Differential cross sections \n\nDICOM Digital Imaging and Communications in Medicine \n\nDVH Dose volume histogram \n\nEPID Electronic Portal Imaging Device \n\nFWHM Full width at half maximum \n\nGTV Gross tumor volume \n\nIAEA International Atomic Energy Agency \n\nIMRT Intensity Modulated Radiation Therapy \n\nLINAC Linear accelerator \n\nMC Monte Carlo \n\nMLC Multi Leaf Collimator \n\nMRI Magnetic Resonance Imaging \n\nMU Monitor Units \n\nOAR Organ at risk \n\nPBC Pencil Beam Convolution \n\nPDD Percentage Depth Dose \n\nPET Positron Emission Tomography \n\nPHSP Phase-space \n\nPTV Planning Tumor Volume \n\nQA Quality Assurance \n\nSBRT Stereotactic Body Radiotherapy  \n\nSRS Stereotactic Radiosurgery  \n\nSRT Stereotactic Radiotherapy  \n\nSSD Source to Surface Distance \n\nTPS Treatment Planning System \n\nVRT Variance Reduction Technique \n\n \n\n \n\n  \n\n\n\nviii \n \n\nList of Figures \n \n\nFigure 2.1 \u2013 Diagram of a linear accelerator in photon mode [10]. .............................................. 6 \n\nFigure 2.2 \u2013 Multileaf collimator [12]. .......................................................................................... 7 \n\nFigure 2.3  \u2013 Main components of a LINAC [11]. .......................................................................... 8 \n\nFigure 2.4 - Basic design of a cylindrical Farmer type ionization chamber [15]. ........................... 9 \n\nFigure 2.5 \u2013 Water tank phantom for basic dosimetry[18]......................................................... 10 \n\nFigure 2.6 \u2013 Geometrical PDD definition.  Q is an arbitrary point at depth Z and P is the point at \n\nZmax. A corresponds to the field size [11]. ................................................................................... 11 \n\nFigure 2.7 \u2013 PDD curves in water for various photon beams at SSD of 100 cm [11]. ................. 11 \n\nFigure 2.8 \u2013 Beam profiles of 10 MV at various depths in water, for field sizes of 10 cm x 10 cm \n\nand 30 cm x 30 cm[11]. ............................................................................................................... 12 \n\nFigure 2.9 \u2013 a) 3D Conformal RT technique using uniform beams; b) IMRT technique using non \n\nuniform beams [17]. .................................................................................................................... 15 \n\nFigure 2.10 \u2013 Beam incidence and dose color wash on 3D-CRT (on the left) and Beam incidence \n\nand dose color wash on IMRT(on the right) [21]. ....................................................................... 15 \n\nFigure 2.11 \u2013 Solid water phantom used in IMRT treatments quality control [45]. ................... 21 \n\nFigure 2.12 \u2013 Scheme that has all the components of PRIMO [55]. ........................................... 23 \n\nFigure 3.1 \u2013 PRIMO window that opens when new Project is selected...................................... 28 \n\nFigure 3.2 \u2013 Parameters of Segment 1. ....................................................................................... 28 \n\nFigure 3.3 \u2013 Variance reduction configuration for s1. ................................................................ 29 \n\nFigure 3.4 \u2013 Simulation configuration. ........................................................................................ 29 \n\nFigure 3.5 - Parameters of Segment 2. ........................................................................................ 30 \n\nFigure 3.6 \u2013 Configuration of the irradiation field. ..................................................................... 31 \n\nFigure 3.7 - Parameters of Segment 3. ........................................................................................ 31 \n\nFigure 3.8 - Variance reduction configuration for s3. ................................................................. 32 \n\nFigure 3.9 \u2013 Solid water phantom used in IMRT treatments quality control in Porto IPO being \n\nmounted on the LINAC table for a verification procedure. ........................................................ 35 \n\nFigure 3.10 \u2013 PTW matrix of 27 x 27 cm\n2\n formed by 729 ionization chambers, spaced by 1 cm, \n\nwhich is used in the solid water phantom at IMRT treatments quality control [45]. ................. 35 \n\nFigure 3.11 \u2013 MLC static configuration. ...................................................................................... 37 \n\nFigure 3.12 \u2013 Example of Dynamic IMRT divided into 89 static MLC shaped fields. .................. 37 \n\nFigure 3.13 \u2013 Simulation Setup. The red mark indicates the isocenter placed at the center of \n\nthe ion chamber array. The isocenter is at 100 cm distance from the beam source. The \n\n\n\nix \n \n\nnumerical voxelized phantom is created by the internal conversion tool of PRIMO, once the CT \n\nscan calibration curve is introduced. .......................................................................................... 38 \n\nFigure 4.1 - Maximum dose depth. ............................................................................................. 40 \n\nFigure 4.2 \u2013 Flatness over the years for lateral profile X. ........................................................... 41 \n\nFigure 4.3 \u2013 Symmetry over the years for lateral profile X. ........................................................ 41 \n\nFigure 4.4 - Flatness over the years for lateral profile Y. ............................................................ 42 \n\nFigure 4.5 - Symmetry over the years for lateral profile Y. ......................................................... 42 \n\nFigure 4.6 \u2013 Number of histories in function of the simulation time. ........................................ 44 \n\nFigure 4.7 \u2013 PDDs from simulations with the same conditions but with different time as stop \n\ncriteria. A \u2013 PDD from simulation with 1.97 x 10\n6\n histories. B \u2013 PDD from simulation with 9.37 x \n\n10\n6\n histories. ................................................................................................................................ 45 \n\nFigure 4.8 \u2013 Percentage of passing points in function of the number of histories. .................... 46 \n\nFigure 4.9 - Percentage of passing points as function of the energy. ......................................... 47 \n\nFigure 4.10 \u2013 Illustration of lateral profile variation when increasing focal spot. ...................... 48 \n\nFigure 4.11 - Percentage of passing points in function of splitting factor. ................................. 49 \n\nFigure 4.12 - Comparison between Clinac 2300 (DHX5) PDD from 2011 and corresponding \n\nPRIMO simulation. The gamma function analysis (2%, 2mm) showed that 100% of the points \n\nwas lower than 1. ........................................................................................................................ 50 \n\nFigure 4.13 - Comparison between Clinac 2300 (DHX5) lateral profile Y from 2011 and \n\ncorresponding PRIMO simulation. The gamma function analysis (2%, 2mm) showed that \n\n90.54% of the points was lower than 1. ...................................................................................... 50 \n\nFigure 4.14 \u2013 Phantom Setup. ..................................................................................................... 50 \n\nFigure 4.15 \u2013 Comparison between Clinac 2300 (DHX5) PDD from 2011 and corresponding \n\nPRIMO simulation. The gamma function analysis (2%, 2mm) showed that 99.66% of the points \n\nwas lower than 1. ........................................................................................................................ 51 \n\nFigure 4.16 \u2013 Comparison between Clinac 2300 (DHX5) lateral profile X from 2011 and \n\ncorresponding PRIMO simulation. The gamma function analysis (2%, 2mm) showed that 100% \n\nof the points was lower than 1. .................................................................................................. 52 \n\nFigure 4.17 - Comparison between Clinac 2300 (DHX5) lateral profile Y from 2011 and \n\ncorresponding PRIMO simulation. The gamma function analysis (2%, 2mm) showed that 100% \n\nof the points was lower than 1. .................................................................................................. 52 \n\nFigure 4.18 \u2013 PRIMO simulation results. ..................................................................................... 54 \n\nFigure 4.19 \u2013 Image output created by MATLAB from PRIMO notepad document. .................. 54 \n\nFigure 4.20 - Comparison between PRIMO simulation and LINAC irradiation of an open field. 55 \n\nFigure 4.21 - Comparison between PRIMO simulation and TPS of an open field. ...................... 56 \n\n\n\nx \n \n\nFigure 4.22- Comparison between TPS and LINAC irradiation of an open field. ........................ 57 \n\nFigure 4.23 \u2013 Comparison between PRIMO simulation and TPS of a static MLC field. ............... 58 \n\nFigure 4.24 - Comparison between PRIMO simulation and LINAC irradiation of a static MLC \n\nfield. ............................................................................................................................................. 59 \n\nFigure 4.25 - Comparison between TPS and LINAC irradiation of a static MLC field. ................. 60 \n\nFigure 4.26 \u2013 Gafchromic film after the dynamic field irradiation.............................................. 61 \n\nFigure 4.27 \u2013 2D Comparison obtained in Doselab between dynamic field measured with a \n\ngafchromic film and with the same measurement in ion chamber matrix. The gamma function \n\nanalysis (3%, 3mm) showed that 98.8% of the points was lower than 1. .................................. 61 \n\nFigure 4.28 \u2013 A - Dose distribution for the dynamic IMRT treatment, measured with ionization \n\nchamber array, placed at 100 cm distance from the LINAC head under 5 cm of water \n\nequivalent. B \u2013 Dose distribution at the matrix for the simulated dynamic plan. C - Comparison \n\nbetween PRIMO simulation and LINAC irradiation of a dynamic MLC field. .............................. 62 \n\n\n\nxi \n \n\nTable of Contents \n \nAcknowledgments .......................................................................................................................... i \n\nResumo .......................................................................................................................................... ii \n\nAbstract ......................................................................................................................................... v \n\nList of Communications .................................................................................................................vi \n\nAcronyms ...................................................................................................................................... vii \n\nList of Figures .............................................................................................................................. viii \n\nTable of Contents .......................................................................................................................... xi \n\n1 Introduction .......................................................................................................................... 1 \n\n1.1 Motivation ..................................................................................................................... 1 \n\n1.2 Intensity modulated radiotherapy (IMRT) .................................................................... 2 \n\n1.3 Monte Carlo LINAC simulation ...................................................................................... 3 \n\n1.4 Objectives of this work .................................................................................................. 5 \n\n2 Experimental and theoretical background ............................................................................ 6 \n\n2.1 Linear Accelerators ........................................................................................................ 6 \n\n2.2 Dose measurement ....................................................................................................... 8 \n\n2.3 Phantoms for basic dosimetry ...................................................................................... 9 \n\n2.4 Percentage Depth Dose (PDD) .................................................................................... 10 \n\n2.5 Lateral Profiles acquisition and characterization ........................................................ 11 \n\n2.5.1 Flatness ................................................................................................................ 12 \n\n2.5.2 Symmetry ............................................................................................................ 13 \n\n2.6 Modern Radiotherapy Techniques .............................................................................. 13 \n\n2.6.1 3DCRT .................................................................................................................. 13 \n\n2.6.2 IMRT .................................................................................................................... 13 \n\n2.6.3 Volumetric Modulated Arc Therapy - VMAT ....................................................... 15 \n\n2.6.4 Tomotherapy ....................................................................................................... 16 \n\n2.6.5 SRS, SRT and SBRT ............................................................................................... 16 \n\n2.6.6 Treatment monitoring ......................................................................................... 16 \n\n2.6.7 Image guided patient positioning techniques ..................................................... 17 \n\n2.7 Treatment Planning System (TPS) ............................................................................... 17 \n\n2.7.1 Treatment planning ............................................................................................. 17 \n\n2.7.2 Dose calculation algorithms ................................................................................ 18 \n\n2.7.3 Isodose distributions ........................................................................................... 19 \n\n\n\nxii \n \n\n2.7.4 Dose distribution verification techniques ........................................................... 20 \n\n2.8 Phantoms for IMRT verification .................................................................................. 20 \n\n2.9 Monte Carlo dose distribution calculations ................................................................ 21 \n\n2.10 PRIMO (Penelope based MC code) ............................................................................. 23 \n\n2.11 Use of Gamma Index function for MC simulations validation .................................... 24 \n\n3 Methodology ....................................................................................................................... 26 \n\n3.1 Basic Dosimetry ........................................................................................................... 26 \n\n3.1.1 Basic Dosimetry Curve Analysis ........................................................................... 26 \n\n3.2 PRIMO Simulation ....................................................................................................... 27 \n\n3.3 PRIMO validation ......................................................................................................... 32 \n\n3.4 PRIMO output problem ............................................................................................... 33 \n\n3.5 Quality Assurance (QA) Test ........................................................................................ 34 \n\n3.6 MLC Tests .................................................................................................................... 36 \n\n4 Results and Discussion ........................................................................................................ 39 \n\n4.1 Basic Dosimetry Curves Analysis ................................................................................. 39 \n\n4.2 PRIMO validation ......................................................................................................... 43 \n\n4.3 PRIMO output problem ............................................................................................... 53 \n\n4.4 MLC Tests .................................................................................................................... 54 \n\n5 Conclusions and Future Work ............................................................................................. 63 \n\nBibliography ................................................................................................................................ 67 \n\nAppendices ..................................................................................................................................... i \n\nAppendix A .................................................................................................................................... ii \n\nA.1.  Functions to write a new PRIMO file ................................................................................ ii \n\nA.2. Functions to read and interpret PRIMO files using a slab phantom in the simulation ......iv \n\nA.2. Functions to read and interpret PRIMO files using a CT image in the simulation ............. x \n\n \n\n\n\n1 \n \n\n1 Introduction \n \n\n1.1 Motivation \n \n\nIMRT is a technique that has been progressively implemented since the 90s, in the \n\nUnited States and in Europe. Initially, it started as a technique only used in international \n\nreference institutions, but nowadays a number of smaller radiotherapy departments have it \n\nalso implemented. In Portugal, the scenario is not different, with IMRT being implemented in \n\nmore and more hospitals. This is a technique that allows the geometric conformation of the \n\nradiation beam to the target volume with a high accuracy. Simultaneously, it allows the \n\nmodulation of the beam intensity, which creates fluence maps according to different tumor \n\nactivity [1]. Thus, the results of IMRT clinical application were promising, with direct impact on \n\nthe improvement of patient's life quality, decreasing some adverse effects of therapy [2]. \n\nHowever, IMRT treatments needs supplementary quality assurance tests before its \n\napplication on patients, in addition to those necessary in other conventional radiotherapy \n\ntechniques. These tests have as goal the comparison between the plans calculated by the \n\ntreatment planning system (TPS) with its application to a phantom. Thus, the compatibility \n\nbetween them is estimated. The agreement between them is calculated based on the gamma \n\nindex. If compatibility is higher than 95%, to a gamma index on 3% and 3mm, the treatment is \n\napproved. \n\nSometimes this compatibility is not achieved and, in some cases, there is no apparent \n\nreason to that. The usage of matrix detectors to the practical acquisition of dose fluence is \n\npointed out as possible cause for this incompatibility, because the matrix has spaces with no \n\ndetectors. In IPO Porto is used a PTW 27x27 matrix, which has 729 ionization chambers spaced \n\nby 1 cm. The spaces between chambers have to be interpolated which can be an error source. \n\nFor this reason, more accurate systems to calculate the applied dose profiles would be helpful \n\nin this situation.  \n\nNowadays, Monte Carlo simulations are pointed out as one of the most accurate \n\nmethods to calculate dose distributions in radiotherapy, because of the high range of samples, \n\nwhich allows a dose calculation very close to reality. However, these methods require long \n\ntime of computation and are not much user friendly. Recently, a new program of dose \n\ncalculation using Monte Carlo, named PRIMO, was developed with the advantage of \n\nsimplifying the calculation process to the users, becoming faster and user-friendly. PRIMO is an \n\nexcellent tool of dose distribution calculation, which appears to be very useful in those cases of \n\n\n\n2 \n \n\nIMRT treatment verification that are not compatible because no apparent reason. This fact \n\narose as motivation for the development of this work, because it is believed that within this \n\nproject interesting things about IMRT treatments simulation with Monte Carlo and about IMRT \n\ntreatments verification could be found out, or at least, a big step in this direction.   \n\n  \n\n1.2 Intensity modulated radiotherapy (IMRT) \n \n\nIntensity Modulated Radiation Therapy (IMRT) is a high precision radiotherapy \n\ntechnique that enables the administration of high doses of radiation to the target volume, \n\nwhile minimizing the dose to normal surrounding tissue very effectively. This kind of dose \n\ndistribution is achieved through application of several radiation beams with different incident \n\nangles and different radiation intensities. Thus, a non-uniform dose distribution is created, \n\nbeing conformed to the structures undergoing treatment, whether they are concave or convex \n\n[3]. When compared to conventional radiotherapy techniques, IMRT has the advantage of \n\ndeliver higher intensity dose, minimizing the side effects in healthy tissues and organs \n\nsurround. \n\nThe treatment process begins with the planning Computed Tomography (CT) scan, \n\nwhich is sent to the 3D planning system, so that the medical oncologists could delineate the \n\ntarget volumes and organs at risk. In some cases other image modalities are needed to plan an \n\nIMRT treatment, such as Magnetic Resonance Imaging (MRI) or Positron Emission Tomography \n\n(PET), which are fused with the CT planning to help doctors to delineate the volumes of \n\ninterest. \n\nIn IMRT the plan is made by a technique called \u201cinverse treatment planning\u201d, which \n\nmeans that minimum and maximum doses, required for tumor control, are prescribed in the  \n\ntarget volumes. The same thing happens to healthy tissues, in which are also prescribed \n\nmaximum doses. Thus, the dose distribution fits precisely around the tumor or target volume, \n\nsaving the healthy tissues. \n\nIn general, this modality of radiotherapy uses about five to nine radiation fields \n\noriented around the patient and administered by linear accelerators (LINAC) collimation \n\nsystems with multiple leaves, which are called MLC (Multi Leaf Collimator). The dose \n\ndistribution adapted to the volumes to treat is achieved because of the movement of the MLC \n\nleaves and because of the incidence angle of the beams [4], as already referred.  \n\nIt is a highly complex technique in which a large number of professionals are \n\ninvolved, such as radiation oncologists, dosimetrists, radiation technologists and medical \n\n\n\n3 \n \n\nphysicists. The complexity of the process involves a very accurate verification of the \n\nadministered dose through quality checks performed by the medical physicists, for each plan, \n\nbefore apply it to a patient. These tests are performed using phantoms that are irradiated with \n\nthe dose planed by dosimetrists in TPS. Then, the dose distribution obtained in the phantom is \n\ncompared with the one calculated in TPS and if they are compatible, the planned treatment \n\ncan be applied to the patient.  \n\n \n\n1.3 Monte Carlo LINAC simulation \n \n\nMonte Carlo simulation is a statistical methodology that relies on a big random \n\nsampling to get similar results to reality. It allows you to experiment with variables a \n\nsufficiently large number of times to more accurately the chance of a result happen. \n\nIn practice, whenever you come across situations with some level of uncertainty and \n\nwant to use Monte Carlo simulation, you will have to go through four steps. First, a model of \n\nthe problem is done. Second, random values are generated for the uncertainties of the \n\nproblem. Then, the third step, the values uncertainties are replaced to calculate the result. \n\nFinally, the solution of the problem is estimated. With the evolution of these methods, their \n\napplication was extended to several fields of study, as for example in radiotherapy. \n\nMonte Carlo simulations started to be used in radiotherapy dose calculations, \n\nbecoming a common method to check other dose calculation methods in complex cases, \n\nwhere the simple methods were not able to work accurately. The development of a Monte \n\nCarlo beam model for linear accelerators (LINACs) was one of the first and most important \n\nstep in Monte Carlo dose calculations. The calculation of the exact dose by Monte Carlo \n\nmethod requires accurate characterization of the radiation source [5]. \n\nTo simulate the production of photon beams in a LINAC, the head components have to \n\nbe precisely defined because they influence the output beam. Commonly, these components \n\nare the target, primary collimator and flattening filter, which have the greatest influence on \n\nthe shape of the photon spectrum; and also the ionization chamber, the mirror and the \n\nsecondary collimator. Information about components geometry and materials of the LINAC can \n\nbe obtained from the manufacturer. \n\nTo evaluate the dose distribution in a particular geometry, it is necessary that the state \n\nof particles in the incident beam is precisely known, i.e. energy, orientations and positions of \n\nphotons, electrons and positrons. This data set is called phase space files (PHSP). Obtain a \n\nphase space in MC simulations of LINACs is achieved by defining a sensitive volume that stores \n\n\n\n4 \n \n\ninformation about particles passing through. Generally, this volume is a thin circular cylinder \n\nthat sits above the secondary collimator. In this case the phase space becomes a virtual LINAC \n\nand can be used in different simulations, paying attention if the amount of particles stored in \n\nthe file is a sufficient sample to obtain the required precision.  \n\nPhase space files (PHSP) are used as a primary generator in a simulation, which avoids \n\nthe need for a detailed description of the geometry and materials, which are often a trade \n\nsecret, and are rarely shared with the user`s machine. The availability of data PHSP also allows \n\neasy use of various beam qualities dosimetry studies, as detector characterization and the \n\ndevelopment of dose protocols. \n\nThe International Atomic Energy Agency (IAEA) has promoted a project to build a \n\ndatabase to make public representative PHSP files of linear accelerators (and Co-60 units) used \n\nin external radiotherapy, compiling the existing data that has been properly validated. The \n\nIAEA PHSP format was designed and approved by a committee of international experts for use \n\nin medical applications [6]. This format was implemented in newer versions of general purpose \n\nMC codes as BEAMnrc / EGSnrc and Penelope, which are considered the state of -the -art for \n\nthe electron-photon transport engaged in medical applications[7]. More recently, a Penelope \n\nbased computer software named PRIMO was created, which is  promising software in Monte \n\nCarlo LINAC simulation and will be used in this work. \n\nPRIMO project was released in 2013 and it is a program that simulates linear \n\naccelerators and estimated absorbed dose distributions in water phantoms and CT scans (in \n\ndicom format). This software combines an appealing graphical interface to the user with \n\ncomputation processes based on the Monte Carlo code PENELOPE. The most of Varian and \n\nElekta LINACs can be simulated by PRIMO, including electron applicators and multileaf \n\ncollimators (MLC). The radiation fields may be stored in intermediate phase-space files which \n\ncomply with the IAEA format. Thus, simulations can be done by steps and using information \n\nfrom other simulations already performed, saving computing resources and time. The program \n\nhas also graphical and numerical tools to analyze phase-space files. Its graphical interface \n\nallows users to simulate and analyze results without performing very elaborate procedures [8]. \n\nThereby, a prior very detailed knowledge of the Monte Carlo method or the inner LINAC \n\noperation is not a prerequisite to perform simulations at Primo, which does not occur in other \n\nsuch programs. \n\n \n\n \n\n\n\n5 \n \n\n1.4 Objectives of this work \n \n\nThis project aimed to demonstrate the existence of an alternative method, based on \n\nMonte Carlo simulations, to calculate dose distribution profiles of IMRT treatments, since they \n\nrequire a verification process before applying the treatment to a patient. This study intends to \n\ndemonstrate the usefulness of PRIMO in this context. Sometimes, IMRT treatments \n\nverification fail, i.e., the treatment plan does not correspond to the one irradiated in the \n\nphantom, without any apparent reason. That can happen due to physical limitations of MLC, \n\nwhich leads to LINAC incapacity to reproduces the generated plan in TPS. Another fact pointed \n\nout is related to the fact that the verification processing is performed using a matrix, which \n\nhave ionization chambers separated by 1 cm. This makes the data acquisition of irradiations \n\ndiscrete in space, meaning that some results must be interpolated. This interpolation could not \n\nmatch exactly to the planned by TPS, being necessary to redo the verification process. Thus, \n\nthis project aimed to demonstrate that PRIMO software has potential to simulate IMRT \n\ntreatments and, perhaps, in the future, PRIMO can be used for IMRT verifications of dose \n\ndistributions calculations, when there is no correspondence between TPS and LINAC \n\nirradiation. In order to achieve this major goal, it is necessary to structure the work in stages. \n\nFirst of all, PRIMO software must be validated. At this stage the main goal is to \n\ndemonstrate that the program can simulate a Clinac 2300, one of the LINACs used in IPO \n\nPorto. That is made by comparing basic dosimetry curves simulated and obtained with LINAC. \n\nThe second task is related to the validation of the MLC. Thus, a field with a given \n\nirradiation features and a given MLC conformation is simulated with Primo. At this stage, the \n\nobjective is to demonstrate that simulation results are compatible with LINAC irradiation of the \n\nsame field and with its calculation in TPS. As a result, there will be MLC validation and \n\nconsistent evidence that the program can simulate a static irradiation field. \n\nEnding the project, the last step has as objective the simulation of a single dynamic \n\nfield and also, its comparison with LINAC irradiation and TPS calculation of this same field. If \n\nthe three modalities are compatible, the main objective of this work is fulfilled, proving the \n\npotential of PRIMO software to simulate a complete IMRT treatment, once it successfully \n\nsimulates a single irradiation field.  \n\n\n\n6 \n \n\n2 Experimental and theoretical background \n \n\n2.1 Linear Accelerators \n \n\nRadiation therapy consists on the usage of high energy radiation for tumors \n\ntreatment, making them smaller by the destruction of tumor cells. In this technique, X-rays, \n\ngamma rays and charged particles could be used. Radiation can be applied by an external \n\ndevice to the body, which is called external radiotherapy, or inserting radioactive material into \n\nthe body, near to cancer cells, which is called brachytherapy. \n\nMost of the time, external radiation therapy sessions are made using a linear \n\naccelerator (LINAC), equipment that produces high energy x-rays.   This radiation is applied to \n\nthe patient, in the tumor region in a way that tumor cells are destroyed and healthy tissues \n\naround the tumor are saved. \n\nThe radiation production by a LINAC equipment is based on thermionic emission, \n\nsimilarly to what occurs in conventional x-rays. Thereby, an electron beam is emitted by an \n\nelectron gun and accelerated in a tube  due to high frequency microwaves generated by a \n\nMagnetron or a Klystron [9]. The electrons can be used directly to treatments on body surface \n\nor they can hit a metal target of high atomic number and be transformed into photons to use \n\nin deeper treatments (Figure 2.1).  For this reason the LINACs make available two or more \n\nphoton energies and several electron energies. \n\n \n\nFigure 2.1 \u2013 Diagram of a linear accelerator in photon mode [10]. \n\n \n\nThe beam modulation and its alignment are achieved by collimators in the inside of \n\nthe LINAC head. All the LINACs have collimators, known as traditional collimators, which are \n\ndistinguished between primary and secondary collimators. The primary collimator is made up \n\nof a relatively large lead block (or simply a heavy metal alloy), in order to produce a cross \n\nconical beam. The secondary collimator consists in pairs of metal blocks positioned in a \n\nperpendicular way between them. These blocks are called jaws and they control the field size \n\nfor each treatment. This type of collimators only restrict rectangular fields [11].  \n\n\n\n7 \n \n\nHowever, the most recent models of LINACs have an additional type of collimation \n\nmade of several thin leaves that allows a better conformation to the tumor shape. This system \n\nis called Multileaf Collimator (MLC) and it allows the irradiation of irregular fields without \n\npersonalized protections for each patient (Figure 2.2). This system of collimation in a LINAC \n\nbrings an increase on the initial investment but, in a long term this cost is overcome. This \n\nhappens because individual protections hard to do are not needed, the treatment time is \n\ndiminished, which increases the profitability of the LINAC and improve the treatments. \n\nNowadays, the MLC used in clinical practice have 80 till 160 leaves, each one with some \n\nmillimeters until 1 cm of wide. Every leaf is controlled with a computer, thus conformations \n\nwith more than 1 mm of accuracy can be achieved and consequently irregular fields can be \n\nformed.   \n\n \n\nFigure 2.2 \u2013 Multileaf collimator [12]. \n\n \n\nIn the LINAC head, ionization chambers are also present, which allow the dose \n\nmonitoring and the end of the treatment when the prescribed dose has been delivered.  The \n\ngantry is the LINAC component that moves around the table where the patient is lying down. \n\nThe table movements can be longitudinal, lateral and rotational.  In the LINAC positioning the \n\nisocenter has to be placed in a volume of millimeters for every movement. Multiple or \n\nrotational beams are applied but in all cases the tumor must be the key target. One way to \n\nensure this happens is to locate the tumor on the isocenter on which everything runs around. \n\nIn Figure 2.3  a blueprint of a LINAC is represented.  \n\nSeveral diseases can be treated with a LINAC, using several techniques such as \n\nconventional techniques, Intensity-Modulated Radiotherapy (IMRT), Imaging Guided Radiation \n\n(IGRT), Stereotactic Radiosurgery (SRS) and Stereotactic Body Radiotherapy (SBRT) [13].  \n\n \n\n\n\n8 \n \n\n \n\nFigure 2.3  \u2013 Main components of a LINAC [11]. \n\n \n\n2.2 Dose measurement \n \n\nCurrently the biological effects produced in irradiated tissues are associated with a \n\nquantity called absorbed dose. This quantity is defined as the average energy deposited per \n\nmass unit of a certain volume element and it is measured in gray (1Gy = 1J / kg)[14]. Absorbed \n\ndose is a macroscopic quantity, not stochastic and therefore not described the sequence of \n\nmicroscopic energy deposition processes. However, it is the spatial distribution of ionization \n\ncaused by the incident radiation that determines the biological effect.  \n\nIonizing radiation itself cannot be measured directly. The detection is performed by \n\nthe result produced by radiation interaction with sensitive means (detector). To be used as a \n\ndose meter for ionizing radiation (which is called dosimeter), a material must have certain \n\nproperties such as: accuracy and precision in measurement, linearity, dose or dose rate \n\ndependence, energy dependence, directional dependence and spatial resolution [15]. \n\nIn the measurement process of dose absorbed, several types of detectors of different \n\nmaterials and shapes can be used, in a radiotherapy context. The most common are the \n\n\n\n9 \n \n\nionization chambers, followed by dosimetric radiosensitive films, solid state detectors (as TLDs) \n\nand electronic devices, usually made of silicon. \n\nIn general, an ionization chamber is constituted by a center electrode (anode) and the \n\nchamber wall, which is coated with a conductive material that acts as cathode. The detector \n\nsensitive volume is delimited by the chamber wall, forming a cavity filled with a gas or a gas \n\nmixture at a relatively low pressure. Between the anode and the cathode, a potential \n\ndifference is applied to separate the ion pairs produced. As a result, negative ions migrate to \n\nthe anode and positive ions to the cathode. This ion flow produces an extremely low electric \n\ncurrent which can be measured by an electrometer, a device that measures small currents \n\n[15]. \n\nThe Farmer type ionization chambers (Figure 2.4) are widely used due to its accuracy in \n\nreading. It is recommended for MV photon beams and for electron beam with energies above \n\nbetween 10 MeV to 45 MeV [16]. \n\n \n\nFigure 2.4 - Basic design of a cylindrical Farmer type ionization chamber [15]. \n\n \n\n2.3 Phantoms for basic dosimetry \n \n\nThe calibration of a LINAC consists in a set of procedures in order to getting depth \n\ncurves yield and dose profile for each irradiation field, energy, type of radiation and for each \n\nbeam modifier accessory. To obtain this dosimetric database for a radiation treatment unit is a \n\nmeticulous experimental work, which is called basic dosimetry [17].  \n\nUsually, this calibration is performed in a cubic water phantom (Figure 2.5), whose \n\ndimensions are much greater than the irradiation fields dimensions used in clinical situations. \n\nThe incidence of the beam is perpendicular to the water surface at a specific distance from the \n\nfocus of the radiation. The set - up has ionization chambers to acquire the data. \n\n\n\n10 \n \n\n \n\nFigure 2.5 \u2013 Water tank phantom for basic dosimetry[18]. \n\n \n\n2.4 Percentage Depth Dose (PDD)  \n \n\nThe Percentage Dose Depth (PDD) is a curve that shows a ratio between the \n\nabsorbed dose in several depths and the absorbed dose in a reference depth (Zmax). In \n\nEquation 1 is seen the quotient that defines a PDD, in which Dd represents the dose at any \n\ndepth and Dd0 represents the dose at a fixed reference depth (Figure 2.6) [19]. This curve is \n\ndefined for a given material, for a specific field of irradiation, for a certain irradiation beam \n\nenergy and Source to Surface Distance (SSD) [11]. \n\n \n\n  \n  \n\n   \n                                                        Equation 1 \n\n \n\nThe PDD curve has an initial point which represents the dose deposited on a patient \n\nskin (or phantom surface). The photons interact with the matter, which increase the dose in \n\nthe patient (or phantom) until the maximum. That area, between incident surface and the \n\npoint where the maximum dose is achieved is called build-up region. In this area the \n\ninteraction between photons and tissues releases electrons, which leave their energy in a \n\ncertain distance of their origin.  \n\nThe percentage depth dose (beyond the depth of maximum dose) increases with \n\nbeam energy. Higher-energy beams have greater penetrating power and thus deliver a higher-\n\npercentage depth dose (Figure 2.7). In the practice, the acquisition of these profiles is made by \n\nusing a water phantom, which is a tank made of acrylic full of water with controlled height and \n\nleveling.  \n\n \n\n\n\n11 \n \n\n \n\n \n\nFigure 2.6 \u2013 Geometrical PDD definition.  Q is an arbitrary point at depth Z and P is the point at Zmax. A corresponds \nto the field size [11]. \n\n \n\n \n\nFigure 2.7 \u2013 PDD curves in water for various photon beams at SSD of 100 cm [11]. \n\n \n\n2.5 Lateral Profiles acquisition and characterization \n \n\nThe dose distribution (along the) the central axis is only a portion of the patient\u2019s \n\ndose distribution. For two or three dimensions the distribution is achieved by the combination \n\nof the central axis distribution with the off-axis profiles. The dose measurement of these last \n\nprofiles is made on perpendicular axis to the central one using some depths of acquisition. The \n\nmost used depths dose of measurement are the depth of maximum dose , and the 5, 10 cm, 20 \n\nand 30 cm, which are used for the planning systems. \n\nThe profile of a megavoltage radiation beam is composed by three distinct regions: \n\nthe central region, the umbra, and the penumbral region (Figure 2.8). The central region goes \n\nfrom the central axis to 1 cm or 1.5 cm of the geometric field border. The umbra is the region \n\noutside the radiation field. The penumbral region is the one that suffers the source penumbra \n\n\n\n12 \n \n\ninfluence, the collimator radiation transmission and radiation scatter, which together make the \n\nphysical penumbra. In this region the dose change abruptly and depends on the source size, on \n\nthe collimation position and the lateral electronic scatter.  \n\nThe beam profile analysis is based on some parameters that define its uniformity, \n\nwhich are the flatness and symmetry. \n\n \n\n \n\nFigure 2.8 \u2013 Beam profiles of 10 MV at various depths in water, for field sizes of 10 cm x 10 cm and 30 cm x 30 \ncm[11]. \n\n \n\n2.5.1 Flatness \n\n \n\nThe flatness is a parameter calculated using the maximum and minimum dose values \n\nof 80% of the beam profile central part, as can be seen at Equation 2. \n\n \n\n      \n         \n\n         \n                                                 Equation 2 \n\n \n\nAccording to the LINAC components and details of its beam an excess of filtration can \n\nbe seen on the central axis for the maximum dose depth. This fact occurs because the LINAC \n\nhas a filter which will flat the beam. This effect will be less pronounced with the increase of the \n\ndepth. In this situation the profile will present more rounded borders rather than peaks. The \n\nemission of lower energy photons outside the central axis explain this fact, when comparing to \n\nthe ones emitted on the central axis [11].  \n\nThe traditional LINACs for clinical use usually require that the flatness would be lower \n\nthan 3%, for measurements with a 10 cm depth and a SSD of 100 cm and for the bigger field \n\navailable (commonly 40 x 40 cm\n2\n). \n\n \n\n\n\n13 \n \n\n2.5.2 Symmetry \n\n \n\nThe symmetry is a parameter measured at the maximum dose depth, since it is the \n\nmost critical area for this evaluation, because in that point the beam profile has the peaks \n\nalready referred. According to Task Group 142 [20], for the same profile, the beam should \n\npresent a symmetry with a maximum disagreement of 2% between two points at the same \n\ndistance from the central axis.  \n\nAnother way to measure beam symmetry is calculating the areas besides the central \n\naxis until the point of 50% dose value and compare them using Equation 3. \n\n \n\n      \n            \n\n            \n                                         Equation 3 \n\n \n\n2.6 Modern Radiotherapy Techniques  \n \n\n2.6.1 3DCRT \n\n \n\nThe tridimensional conformal radiotherapy (3D-CRT) is a technique that uses multiple \n\nbeams with uniform radiation intensity to irradiate the exact treatment area, according to the \n\nsecurity margins [21]. This exact targeting makes it possible to use higher levels of radiation in \n\ntreatment, which are more effective in shrinking and killing tumors. \n\n \n\n2.6.2 IMRT \n\n \n\nIntensity Modulated Radiotherapy is an evolution of 3D-CRT, because the applied \n\nfields have variable intensities (Figure 2.9). It is a modality of external radiotherapy extremely \n\naccurate that allows the administration of high radiation doses on the target volume, reducing \n\nthe dose in the healthy tissues around. The radiation is applied according to the tridimensional \n\nshape of the tumor, which is achieved by the beam modulation (Figure 2.10).  Similarly to 3D-\n\nCRT, IMRT allows a geometrical conformation adding a dosimetric adjustment to the irradiated \n\narea [17]. Therefore, the toxicity of the treatment, the side effects in a short and long term will \n\nbe reduced [22]. \n\nDespite the benefits of IMRT in relation to the 3D-CRT, this technique requires a \n\nmore severe treatment plan. In both techniques the targets and structures to protect are \n\n\n\n14 \n \n\nselected by the doctor, which are called the volumes of interest for the treatment. However, in \n\nIMRT a technique called inverse planning is introduced, while in 3D-CRT a common planning is \n\nused. In 3D-CRT simple beams are shaped considering field margins that will compensate the \n\ndaily variations in configuration and the beam characteristics. In this case, the quantity and \n\nangle of incidence of beams and its configuration are chosen and then the dose in the volumes \n\nof interest is calculated. Then the plan is analyzed in terms of dose, confirming if the maximum \n\ndose in the organs at risk is not achieved. The plan can be remade changing some parameters \n\nin order to find the best treatment plan: the one with lower dose in the organs at risk and \n\nhigher dose at the tumor. On the other hand, in the IMRT treatment planning the opposite \n\nprocess occurs. The dose in the target and in the structures to be protected is prescribed by \n\nthe doctor.  For this purpose tolerance levels for each organ have to be determined [23]. Then, \n\nthe program used to planning creates a series of modulation patterns in order to find the \n\nconfiguration that best match to the desired plan [21]. In general, 5 to 9 irradiation fields are \n\nused in an IMRT treatment, which are administered to the patient by linear accelerators with \n\nmulti-leaf collimation systems. \n\nAccording to the way of delivering IMRT, there are two techniques that can be \n\ndistinguished: IMRT with segmental MLC, which is known as step and shoot; and IMRT with \n\nDynamic MLC. The step and shoot technique is a discrete mode of IMRT delivery, in which the \n\nMLC leaves move to their next position while the beam is off [24]. In this case, the sum of all \n\nradiation segments will produce the intensity modulated field. In contrast, with the dynamic \n\nMLC technique the MLC leaves are in continuous motion during all treatment. The desired \n\nintensity of radiation in a specific point is achieved by a variation on MLC leaves motion speed \n\nand the changes in their position[21].  \n\nEven though IMRT has emerged in the beginning as an experimental technique, \n\nmainly in academic environment, nowadays there are a growing number of centers in Europe \n\nusing IMRT in clinical practice [25]. Currently, IMRT is particularly indicated to the treatment of \n\nprostate tumors, head and neck, gynecological, gastrointestinal and central nervous system \n\ntumors. \n\nThis technique requires many resources and time to its implementation. A large \n\nnumber of professionals are necessary from treatment planning, until its implementation and \n\nalso some procedures have to be done. Thus, acceptation and commissioning tests are needed \n\nto implement IMRT, but also quality assurance tests of the treatments are a requisite to apply \n\nan IMRT treatment to a patient.  \n\n\n\n15 \n \n\n \n\nFigure 2.9 \u2013 a) 3D Conformal RT technique using uniform beams; b) IMRT technique using non uniform beams [17]. \n \n\n \n\nFigure 2.10 \u2013 Beam incidence and dose color wash on 3D-CRT (on the left) and Beam incidence and dose color wash \non IMRT(on the right) [21]. \n\n \n\n2.6.3 Volumetric Modulated Arc Therapy - VMAT \n\n \n\nVMAT allows carrying intensity modulated treatment only in one arc. This is achieved \n\nthrough the simultaneous variation of several parameters, as MLC leaves pattern, dose rate \n\nand rotation speed of the gantry. This treatment technique produces high compliance \n\nabsorbed dose distributions and is quite effective in terms of treatment time [26]. \n\nRapidArc \u2122 (Varian Medical Sistems, Palo Alto, CA, USA) is one of the solutions \n\nalready in the market for this type of treatment [27]. RapidArc\u2122 has recently been introduced \n\nin clinical practice in various institutions after an intensive validation [28]. This introduction \n\nrequires a new work methodology, being necessary introduce a quality assurance program and \n\nsystematic dosimetric verification. \n\n\n\n16 \n \n\n2.6.4 Tomotherapy \n\n \n\nTomotherapy is a type of image-guided IMRT that combines imaging and treatment \n\ncapabilities in one unit [29]. The part of tomotherapy machine that delivers radiation for both \n\nimaging and treatment can rotate completely around the patient in the same manner as a \n\nnormal CT scanner. This equipment can capture MV CT images of the patient\u2019s tumor \n\nimmediately before treatment sessions, to allow for very precise tumor targeting and sparing \n\nof normal tissue. The intensity modulation is obtained by a binary collimator that opens and \n\ncloses, according to computer control. Meanwhile the fan beam runs continuously around the \n\npatient and bed moves at a predetermined rate[30]. \n\n \n\n2.6.5 SRS, SRT and SBRT \n\n \n\nStereotactic Radiosurgery (SRS), Stereotactic Radiotherapy (SRT) and Stereotactic \n\nBody Radiotherapy (SBRT) are three techniques closely related. All of them are delivered on a \n\nLINAC and require extreme precision in patient positioning, because they are normally used \n\nwhen exist the need of spare immediately adjacent normal tissue[31]. \n\nIn SRS a high radiation dose is given to a certain brain region of a patient in one or a \n\nfew fractions. The goal of SRT is to disrupt cell division processes without completely \n\ndestroying the local tissue. SRS, on the other hand, is an ablative technique where the goal is \n\nto deliver sufficient dose to the target area to kill all the cells in the target region. In this \n\ntechnique a fractionated schedule of delivery is used, although that schedule may be \n\naccelerated in a hypofractionated regime of as few as 3-5 treatment sessions. The difference \n\nbetween this technique and SBRT is the body region where the technique is applied. Thus the \n\nfirst one treats brain and spine tumors , the second one treats other body regions as lungs, \n\nliver, pancreas and kidneys, for example [32].  \n\n \n\n2.6.6 Treatment monitoring \n\n \n\nIn radiotherapy treatments the periodic verification of radiation fields is important, \n\nwhich is achieved through the use of images. In the most common LINACs, the image \n\nacquisition systems comprise a robotic arm having a panel with a matrix of detectors, called \n\nportal imaging system. With these detectors it is possible to obtain images, resulting from \n\npatient output radiation, due to the attenuation caused by tissues. These images contain \n\n\n\n17 \n \n\nanatomical information of the patient and are used to verify the effects of the treatment. \n\nThus, in treatment monitoring by portal images periodic information on target position and \n\nmovement are obtained (within the same session or between consecutive sessions). Then it is \n\ncompared with reference imaging, giving feedback to correct the patient setup and optimize \n\ntarget localization. These images also have the potential to provide feedback that may help to \n\nadapt subsequent treatment sessions according to tumor response [33]. \n\n  \n\n2.6.7 Image guided patient positioning techniques \n\n \n\nImage Guided Radiotherapy is a technique that allows checking the patients \n\npositioning while they are in the treatment table. Images can be acquired through the portal \n\nimaging system or with the Megavoltage Cone-Beam CT technique. In the first case, the \n\npatient is irradiated with a very low dose in two orthogonal directions (one above and one \n\nside), which will create 2D images that can be compared with the corresponding image in the \n\nplanning computed tomography (CT). In the second case, the LINAC rotates around the patient \n\nallowing the creation of a 3D image, which is also compared to the CT planning, which gives \n\ninformation about the patient position in relation to the isocenter.  \n\nThe imaging scans obtained are processed by computers to identify changes in a \n\ntumor\u2019s size and location due to treatment. They allow the position of the patient or the \n\nadjustment of the planned radiation dose during treatment. The imaging repetition can \n\nincrease the accuracy of radiation treatment and may allow reductions in the planned volume \n\nof tissue to be treated, thereby decreasing the total radiation dose to normal tissue [34]. \n\n \n\n2.7 Treatment Planning System (TPS) \n \n\n2.7.1 Treatment planning \n\n \n\nThe treatment planning systems (TPS) are used on external radiation therapy to \n\nsimulate the radiation beams and its dose distribution. Consequently, the tumor control is \n\nmaximized and the complications with healthy tissues are minimized.  The help of complex \n\ncalculation systems are needed to elaborate the patients\u2019 treatment plans [35].  \n\nTo start the planning phase patients CT scans are performed, in which they are in the \n\nsame position of the external radiation treatment. Sometimes, when the gross tumor volume \n\n\n\n18 \n \n\n(GTV) location is hard to define, other types of images are required, as PET or MRI for example. \n\nThus, the physician has to delineate the several volumes [36]:  \n\n? GTV (Gross Tumor Volume) \u2013 Tumor or tumor extent detected and / or visible by \n\nmedical palpation or identified in complementary diagnostic images (CT, MRI, PET \n\n/ CT). \n\n? CTV (Clinical Tumor Volume) \u2013 Volume of treating tissue which comprises the GTV \n\nassociated with microscopic disease extent. \n\n? PTV (Planning Tumor Volume) \u2013 Defined by CTV and safety margins (about 1 cm). \n\nThese margins compensate for changes due to the variation in size and shape of \n\nthe CTV tissues and daily variations of the patient's face. \n\n? OAR (Organ at risk) \u2013 Healthy tissues/ organs close to the tumor, whose tolerance \n\ndoses might influence the volume and / or the dose levels to irradiate. \n\n \n\nAfter this selection, the treatment plan is made using the TPS. The treatment plans \n\nfor each patient have information about the position of the gantry, collimators and treatment \n\ntable. The field dimensions, protections to use and dose are also information on the treatment \n\nplan. Based in all selected mechanical properties and dose values assigned to each treatment \n\nplan are found the Monitor Units (MU) that should be applied in each irradiation field of \n\ntreatment. In the final phase of the planning process dose volume histograms are created, \n\nwhich are evaluated by doctors for approval of treatment plan. \n\nThere are several planning systems available in the market, but in the context of this \n\nproject the Eclipse system is the most important to refer, because is the one used in IPO Porto. \n\nWith this system the radiotherapy treatment plan is a faster and easily process. In the \n\nparticular case of IMRT treatments, Eclipse combines tools from 3D-CRT with a fast, accurate \n\nand interactive dose optimization. Furthermore this system also allows automatic optimization \n\nof beam geometry, simplifying the  task of select the best incidence angles of beam radiation \n\nin IMRT [37]. \n\n \n\n2.7.2 Dose calculation algorithms  \n\n \n\nOne of the most used dose calculation algorithm is the pencil beam. This technique \n\nassumes that any collimated photon beam incident on the patient is a group of lots of smaller, \n\nnarrow pencil beams. Each of these pencil beams has a central axis ray along which it deposits \n\n\n\n19 \n \n\nsome dose. The dose deposition pattern varies with the intensity and the spectrum of the \n\nbeam that is incident on the patient [38]. \n\nThe Anisotropic Analytical Algorithm (AAA) is a considered a 3D Pencil Beam \n\nsuperposition-convolution model [26] and it was the first algorithm of this kind being \n\nimplemented on Eclipse Treatment Planning System from Varian Medical Systems. \n\nThe superposition-convolution algorithms are explained by a model in which the \n\ndose deposition is seen as weighted responses (kernels) superposition for specific radiations. \n\nKernels represent the transport and dose deposition energy of secondary particles coming \n\nfrom the irradiation point. When kernels are spatially invariant, this superposition can be \n\nevaluated using convolutions [26].  \n\nAAA applies kernels derived from Monte Carlo calculations, which are sized to be \n\nadjusted to local density. This algorithm considers tissues heterogeneity anisotropically by \n\ndispersing kernels in multiple lateral directions. The final dose distribution is obtained by \n\nsuperposition of the doses from the photon and electron convolutions[39]. Comparing AAA \n\nwith other algorithms as Pencil Beam Convolution (PBC), it presents a better performance, \n\nbecause AAA is able to model with higher precision the electrons transport in a heterogeneous \n\nmedium [40]. The computation time to calculate this algorithm is reduced, and similar to PBC, \n\nwhen calculated in Eclipse. \n\n \n\n2.7.3 Isodose distributions  \n\n \n\nA dose distribution in a three-dimensional volume cannot be characterized only by \n\ndepth dose distribution in the central axis. To represent a planar or volumetric variation in \n\nabsorbed dose, the distributions are represented by lines passing through points with the \n\nsame dose values, which are called isodose curves [19]. \n\nThe planning systems calculate for each field configuration the dose distribution, \n\ngiven by a set of isodose curves, which are quantitatively evaluated from dose volume \n\nhistogram (DVH). The DVHs are statistic dose tools that allow knowing the dose reaching a \n\ncertain volume of a given anatomical structure [17]. With the help of DVHs, a planning \n\nevaluation is made, based on dose distribution analysis around the PTV and OARs. For this \n\nreason, in each image slice, the isodose distributions must be inspected [41]. \n\n \n\n \n\n\n\n20 \n \n\n2.7.4 Dose distribution verification techniques \n\n \n\nBefore the first treatment session, the MUs generated in planning system should be \n\nchecked using an independent verification system. In the case of IMRT treatments, the \n\ncorrelation between MUs and dose delivered to each intensity modulated field is not much \n\nevident, and problems that can occur cannot be predicted by these means [42]. Therefore, for \n\npurposes of dose administered quality control, the achievement of absolute dose and relative \n\ndose verification tests are requirements for IMRT planning. \n\nThe purpose of absolute dosimetry is measure the deviation between the dose \n\nplanned and dose in a point, typically the isocenter, while relative dosimetry has as goal to \n\ndetermine the accuracy of dose distribution. The relative dose verification consists on the \n\ncomparison between the irradiation of a field planed for the patient on a cubic phantom \n\n(always with the angle of the gantry at 0 \u00b0) and the planar image provided by the Electronic \n\nPortal Imaging Device (EPID) (or other verification system) after its irradiation according to the \n\nrespective patient's treatment parameters. The dose distribution plan adapted to a geometric \n\nphantom should also be compared with the resulting dose distribution in irradiated films (or in \n\nother detector) after patient\u2019s treatment simulation. To be considered absolute dose \n\nverification, the absorbed dose in films should be normalized to the isocenter dose value, \n\nobtained with the plan irradiation using a calibrated ionization chamber[43]. \n\nThese tests are protocolled in order to ensure the reliability in the execution of each \n\npatient planning. These protocols include pre-treatment verifications and periodically \n\nverifications over the treatment. \n\n \n\n2.8 Phantoms for IMRT verification \n \n\nA phantom is an object that can represent a patient in terms of absorption and \n\nscattering properties of radiation. A phantom can be geometric or anthropomorphic and can \n\nbe filled with water, homogeneous solid material or materials equivalent to human tissue. All \n\nof them allow the access to relevant dosimetry information, by the introduction of some kind \n\nof detector therein. This makes phantoms an essential tool in the evaluation of equipment \n\noperating conditions or in quality control checks.  \n\nIn daily IMRT treatments verification, a geometric phantom made by solid water \n\nslabs is widely used (Figure 2.11), which simulates the radiation absorption and diffusion \n\nproperties in human tissues. The solid water slabs reproduce the dosimetric properties of the \n\n\n\n21 \n \n\ntissues, in a simple way, reducing anatomy complexity and presenting regular geometries. \n\nThese slabs are made of water-equivalent plastic and have holes for different types of \n\nionization chambers, in particular for Farmer type, allowing that absolute or relative dose \n\nmeasurements be achieved [44]. \n\n \n\nFigure 2.11 \u2013 Solid water phantom used in IMRT treatments quality control [45]. \n\n \n\n2.9 Monte Carlo dose distribution calculations \n \n\nStochastic methods are known since before the advent of computers, however only \n\nin 1947 the name of Monte Carlo Methods has been assigned [46]. This term encompasses a \n\nclass of numerical methods based on random numbers usage. These methods are very used in \n\nareas as physics and mathematics, in particular at large number of independent variables \n\nproblems [47]. \n\nIn Monte Carlo simulations of radiation transport, a particle is seen as a random \n\nsequence of free paths, which ends with an interaction. Therefore, the particle could change \n\nits direction of movement, loses energy, and occasionally produce secondary particles. This \n\nsimulation is the numerical generation of random events and a model to describe them is \n\nneeded. Thus, a set of differential cross sections (DCS) are created for the relevant interaction \n\nmechanisms. The DCSs determine the probability distribution function (PDF) of the random \n\nvariables that characterize an event, such as interaction between successive events of a free \n\npath particle, the type of interaction occurred, and the loss of energy and angular deflection \n\ndue to an interaction [48]. As these PDF are known, it is possible to generate random events by \n\nusing appropriate sampling methods. \n\nMonte Carlo algorithm includes some components that should be highlighted: the \n\nprobability distribution, since the system has to be described by one or more PDFs; the \n\n\n\n22 \n \n\nrandom number generator from where the entire process begins, which must be fast and \n\nreliable. \n\nThe Monte Carlo calculations can take a long time, especially in radiotherapy \n\napplications. For this reason, techniques to increase simulations speed are needed, which are \n\ncalled variance reduction techniques [46]. Particle splitting, Russian roulette and forced \n\ninteraction are three techniques that worth to be highlighting in this context. \n\nIn particle splitting, the particle to being controlled is divided into several particles, \n\nwhich are followed individually. Mathematical aspects of particle splitting are the other \n\nvariance reduction techniques basis. \n\nRussian roulette is a mathematical tool essential to the other variance reduction \n\ntechniques implementation. This technique combines several particles at once, but only a \n\nsingle particle at a time is followed. Accordingly to this, the probability of 1-p (typically 90-\n\n99%) is assigned for the death of a particle, but its weight is increased by a factor of 1/p when \n\nthe particle survives. The necessity of this tool is evident when used with the forced \n\ninteraction (discussed below), since without the particle \"death\" in russian roulette, the first \n\ninteraction would never end. This is a method performed when the particle weight is below a \n\ncertain \"cut\" value. In Russian roulette the variance of the problem is increased, but Monte \n\nCarlo calculation efficiency is also increased. Therefore computer time is saved, which would \n\nbe spent on low-weight particles. \n\nForced interaction technique forces a collision on a given segment of the particle \n\npath, which is located inside the region under study. This should make particles live longer and \n\nhave more chance of being counted. \n\nSeveral Monte Carlo codes are available for simulation of many types of particles \n\ntransport and in a wide range of energies. The most general Monte Carlo codes, as GEANT, \n\nMCNPX or FLUKA, simulate the transport of various types of particles (electrons, positrons, \n\nphotons, protons, neutrons, heavy ions, etc.) to a wide range of energy[49]. Those programs \n\nhave various applications such as detectors simulation response; medical treatments \n\nsimulations; radiological protection dosimetry; study of the radiation effects in \n\nmicroelectronics, etc. More specific codes, such as PENELOPE, EGS, ETRAN, ITS, they focus on \n\nelectrons and photons transport [50].  \n\nMonte Carlo methods are considered the most accurate methods for dose \n\ncalculation in radiotherapy [51]. They can model realistic radiation transport through the \n\nLINAC head, the MLC and the patient anatomy accurately.  In this context, several programs \n\ndirectly indicated to radiotherapy have been developed such as: VMC/XV MC, DPM, MCV and \n\nMCDOSE [50]. These codes use multiple variance reduction techniques and complete \n\n\n\n23 \n \n\ncalculations with a reduce CPU time, in comparison with ordinary EGSnrc calculations [52]. \n\nMost recently, another simulation program of radiotherapy treatments came up, known as \n\nPRIMO, which will be studied next. \n\n \n\n2.10 PRIMO (Penelope based MC code) \n \n\nPRIMO is a Monte Carlo program to simulate a wide range of Varian and Elekta linear \n\naccelerators [53], as well as their electron applicators and multi-leaf collimators. This program \n\nallows the calculation of the dose distribution in the patient in a simple way, without being \n\nrequired deep computing knowledge. This is possible because PRIMO is made of a combination \n\nof several programs [54], which work together in order to make PRIMO a potential tool in \n\nradiotherapy treatments simulations. Also for this reason, PRIMO is interactive, intuitive and \n\nsimple to use, in contrast to other Monte Carlo simulation programs. \n\nThe PRIMO codebase for physical aspects is PENELOPE. It allows the simulation of \n\nradiation transport in a LINAC, as well as the absorbed dose distributions in a phantom or \n\npatient. The remaining constituents of PRIMO programs and their respective functions are \n\nshown in Figure 2.12. \n\n \n\n  \n\nFigure 2.12 \u2013 Scheme that has all the components of PRIMO [55]. \n\n \n\nTo begin the project, a device model to simulate as well as the operation mode \n\n(electrons or photons) must be chosen. Then, the calculations performed by this program can \n\nstart selecting other parameters of interest, which are divided into three phases. In the first \n\none (s1) are determined the energy of irradiation (nominal energy), the initial energy, the \n\nenergy of FWHM, the focal spot of FWHM and the beam divergence. In this step is created a \n\n\n\n24 \n \n\nphase-space file that contains information about the particles created and its interaction on \n\nthe LINAC head. In the second stage (s2) the interaction in the bottom of the LINAC of all \n\nparticles generated in S1 is simulated. The interaction occurs between particles and the jaws, \n\nMLC and air space until the phantom (or patient). In s2 are determined the presence or \n\nabsence of MLC, the number of fields, its size and configuration. In the third and final stage \n\n(s3) the interaction between particles coming from previous segments with the phantom (or \n\npatient) is simulated. Here is chosen the use of a phantom (and its definitions) or a patient CT \n\nimage and the SSD. These three segments can be launched one at a time or all together, but \n\nbefore parameters relating to the variance reduction techniques, simulation time, number of \n\nparticles, number of cores used and with random numbers must be chosen. \n\nOnce all simulation steps are finished, the dose profiles in the phantom (or patient) \n\nare obtained. The generated files can be analyzed using tools provided by PRIMO. To s1 and s2 \n\nthe generated phase space files can be accessed and analyze. In s3, the dose distribution \n\nprofiles can be seen, studied and compared with other calculated or experimental curves. This \n\ncomparison tool is based on the gamma test that will be explained next [55]. \n\n \n\n2.11 Use of Gamma Index function for MC simulations validation \n \n\nA simple way to evaluate the obtained results is overlapping two dose distributions: \n\nfor example, compare a distribution from the TPS with a measured in the LINAC. With this \n\nanalysis it can be seen that the areas are not totally coincident in both images, compatible \n\nregions and less compatible regions can be distinguished. However, obtain more accurate \n\nresults, meaning quantitative data, can be a hard task to do. \n\nThe first criterion used to perform a quantitative evaluation was the dose difference, \n\nwhich is good for regions with low gradient dose. However, for areas with a high gradient dose \n\nthis criterion is not suitable, since small space deviation brings a big dose difference. For this \n\nreason, another criterion, called DTA (Distance-To-Agreement), has been admitted in order to \n\nevaluate the high dose gradient regions. \n\nThe analysis of dose distributions (fluence) is performed comparing the dose and \n\nDTA, which determines if the dose distribution measured with LINAC is in accordance with the \n\none that was planned. In this context, a function called Gamma Analysis or Gamma index has \n\nappeared. \n\nThe dose analysis [56] is a method that combines the dose difference and DTA \n\ncriterions for comparing two dose distributions (e.g., a simulated curve and a curve obtained \n\n\n\n25 \n \n\nexperimentally). The dose difference is evaluated by exploring the dose distribution in the \n\nneighborhood of the experimental points. For a given experimental point P, where the dose in \n\nthe point is de(p), the gamma index, ?, is given by: \n\n \n\n?          \n   \n\n  \n \n \n  \n\n   \n\n  \n \n \n  ,                                      Equation 4 \n\n \n\nwhere are arbitrary constants known as the acceptance criteria for dose difference and DTA \n\n(values used are typically 2% and 2 mm for ?D and??S, respectively). The term ?di is the \n\ndifference between de(p) and the simulated dose at a certain point pi; and ?si is the distance \n\nbetween p and pi. Evaluating the set of points pi and finding the minimum value of the \n\nexpression in brackets the gamma index value is discovered [57]. Through this analysis it is \n\npossible to obtain information about the zones where the dose distribution is in according, or \n\nnot, to the acceptability criteria [58]. \n\n  \n\n\n\n26 \n \n\n3 Methodology \n \n\n3.1 Basic Dosimetry \n \n\nThe validation of the program in study requires the comparison of basic dosimetry \n\ncurves generated by PRIMO with the ones acquired in the LINACs every six months. When both \n\ncurves match according to the gamma index test, PRIMO is validated and other studies can be \n\nstarted. \n\nTo acquire the PDD, in a LINAC, a setup with a water phantom has to be mounted. \n\nFirst of all, the gantry and collimator must be in 0\u00ba and the table on 90\u00ba. Then the tank can be \n\ncentered under the gantry and filled with water. After that the controller and the electrometer \n\nshould be connected to the tank cables and all the equipments can be turned on. The next \n\nstep is level the tank, align it with the lasers, put the thermometer in the water to stabilize, \n\nand adjust the SSD to 100 cm. At that moment, the measuring and reference ionization \n\nchambers (PTW Semiflex Ionization Chamber 31010) can be connected to the electrometer. \n\nThe measuring chamber is dipped until the limit of water surface and the reference chamber \n\nstay in the support above the water tank in the limits of the irradiation field. Finally the \n\npressure and temperature values are noted and the practical acquisition of PDD and lateral \n\nprofiles is started.  \n\nWith the purpose of finding the best curve to use on the validation process, the \n\nvariation of the PDD curve over time (to the same LINAC) will be studied. To reach that goal \n\nthe maximum of the curves will be calculated and compared with the ones obtained in the \n\nacquisition program, called MEPHYSTO.  \n\n \n\n3.1.1 Basic Dosimetry Curve Analysis \n\n \n\nTo analyze the PDD curves the first thing to do is to calculate the curve that better \n\nfits the maximum of the PDD. This is done in order to discover the accurate value of depth to \n\nthe maximum dose, once in practical acquisition the curve obtained is made of discrete points. \n\nThe maximum value is found by an interpolation of the points made by Mephysto. This process \n\nof interpolation is not known, that is why it is so important to calculate the PDD maximum \n\nusing a known procedure. \n\nThe first step in this procedure is to select the maximum values of each curve \n\n(approximately the twelve maximum values) and choose the degree and parameters of the \n\n\n\n27 \n \n\nfunction. The adjustment of these parameters is made by using the solver tool from excel. The \n\nfunction selected was the one in which the sum of the residue difference (between values \n\nfrom Mephysto and the ones calculated by the new function) was minimal. With this step the \n\nfunction is founded for each PDD curve. Calculating the first derivative of the function the \n\nmaximum values of the curve were found. Those values were compared with the ones \n\nobtained with Mephysto and both were analyzed regarding the parameters: quality index (Qi \n\nor QI), the depth of the maximum dose (R100) or 80% and 50% of dose (R50, R80) and \n\npercentage dose at a depth of 100 mm (D100). The quality index parameters are calculated \n\nbased on help documents from Mephysto using Equation 5 and Equation 6, where D200 is the \n\ndose at depth of 200 mm [59]. The same kind of analysis was made to the lateral profiles x and \n\ny. In this case the profiles flatness and symmetry along the years were calculated and \n\ncompared with the ones given by Mephysto. This calculation was made using the equations \n\nalready showed in Flatness and Symmetry on the Theoretical Background, also present in \n\nMephysto help documents [60]. Ending this procedure the curves for comparison and \n\nvalidation of PRIMO can be chosen, which are considered in this context reference curves. \n\n \n\n \n \n \n\n    \n\n    \n                                                                           Equation 5 \n\n \n \n         \n\n \n                                                                              Equation 6 \n\n \n\n3.2 PRIMO Simulation \n \n\nTo start a PRIMO simulation the first thing to do is write the simulation name on \n\nProject ID space that can be seen in Figure 3.1. In the same window is chosen the folder where \n\nthe project is saved, and most important, the LINAC to simulate and the operation mode are \n\nselected. In this work, a Clinac 2300 with operation mode in photons will be always used. The \n\nsimulations were performed in an Intel(R) Xeon(R) CPU E5-2660 v3 @ 2.60GHz 2.60GHz with \n\n16GB of RAM, with 32 CPU cores working at the same time. \n\nAfter that, the simulation segment 1 can be set up as shown in Figure 3.2. In this stage, \n\nparameters as nominal energy, initial energy, energy FWHM, focal spot FWHM and beam \n\ndivergence are defined. The nominal energy used was 6 MV for all the simulations performed. \n\nThe other parameters were changed until the best simulation results were achieved. After \n\nvalidate PRIMO these parameters did not suffered changes. In Figure 3.2 are the parameters \n\nthat get the best accordance with practical results. To simulate this segment a check signal \n\nmust be put in the check box of S1. Other parameters related to S1 should be configured \n\n\n\n28 \n \n\nbefore launch the simulation. The variance reduction techniques configuration will not change \n\nfor all simulations (Figure 3.3). At S1 is chosen the splitting roulette for the splitting above \n\njaws, since all simulations have initial energy lower than 15 MV. For size of splitting region the \n\nsecond option will be selected (fitted to the field size), because in this work only fields with \n\n10x10 cm\n2\n will be simulated. In simulation configuration, the simulation time or the number of \n\nhistories is defined as stopping criteria, as can be seen in Figure 3.4. These parameters affect \n\nstatistics, that\u2019s why after finding the best parameters for S1, a new simulation with a higher \n\nnumber of histories should be done. In this window is also configurable the refresh time for \n\nsimulation partial report and the number of processors used in calculations. The random seeds \n\nshould also be switched before any simulation beginning, in order to obtain more reliable \n\nresults, which change randomly clicking on dices. Then the save button should be pressed and \n\nthe simulation of S1 launch.  \n\n \n\n \n\nFigure 3.1 \u2013 PRIMO window that opens when new Project is selected. \n\n \n\n \n\nFigure 3.2 \u2013 Parameters of Segment 1. \n\n\n\n29 \n \n\n \n\nFigure 3.3 \u2013 Variance reduction configuration for s1. \n\n \n\n \n\nFigure 3.4 \u2013 Simulation configuration. \n\n \n\nIn segment 2 is defined the data related to the jaws, MLC and gantry. To simulate this \n\nstep, similarly to what occurred in S1 it is necessary to check the S2 box, as shown in Figure \n\n3.5. In this work, only the boxes related to MLC and jaws will suffer changes, the remaining \n\nones will not. For all PRIMO simulations in the context of this project, the field size will be 10 x \n\n10 cm\n2\n (Figure 3.6). After validate PRIMO, MLC should be introduced. In the MLC box it is \n\nselected the same MLC present in the simulated LINAC. In this particular case, once it is \n\n\n\n30 \n \n\nintended to simulate the 6MV beam of a DHX HP LINAC from Porto IPO, the millennium 120 \n\nMLC will be choose. After all parameters be defined, the simulation configuration window \n\nshould be opened and select the stopping criteria number of histories that came from S1. \n\nThen, all configurations are saved and S2 simulation is launched.  \n\nSegment 3 is the simulation part related to the dose distribution on the phantom or \n\npatient, thereby is at this stage that information about the receptors of radiation are defined. \n\nIn Figure 3.7 a layout of the configuration window of s3 can be seen. There are the options to \n\nsimulate a dose distribution on a water phantom, on a slab phantom or in a CT. In this work \n\nonly simulations with a water phantom and with a CT were performed. To validate PRIMO the \n\nsimulations were made using the water phantom. For this reason, it was necessary to define \n\nthe grid of calculation: the total size and the bin size. Otherwise, in simulations after PRIMO \n\nvalidation a CT scan of a phantom used in practical measurements was used. In this case there \n\nis no need to complete anything, because CT scan already brings all the information about the \n\ncalculation grid. Defining all this, and the box of S3 with a check signal it is time to configure \n\nthe variance reduction parameters for S3 (Figure 3.8). In this window is checked the splitting in \n\na phantom or CT with a splitting factor of 200. This value was used by recommendation of \n\nPRIMO project authors. After that, the simulation configuration window is opened and once \n\nagain is selected the stopping criteria on the number of histories. Then, this entire \n\nconfiguration is saved and S3 is launched, finishing all the simulation steps. \n\n \n\n \n\nFigure 3.5 - Parameters of Segment 2. \n\n \n\n\n\n31 \n \n\n \n\nFigure 3.6 \u2013 Configuration of the irradiation field. \n\n \n\n \n\nFigure 3.7 - Parameters of Segment 3. \n\n\n\n32 \n \n\n \n\nFigure 3.8 - Variance reduction configuration for s3. \n\n \n\n3.3 PRIMO validation \n \n\nTo validate PRIMO software, the basic dosimetry curves simulated must be \n\ncompatible to the ones selected before, from the biannual LINAC tests. With this correlation \n\nPRIMO is validated, the parameters of s1 are found and there is no need to redo simulations of \n\nthe LINAC head.  \n\nThe discovery of the parameters is done by trial and error, trying one by one all the \n\nparameters that can be adapted by PRIMO and comparing the simulation with the reference \n\ncurves. First of all, the variation of the simulation results according to the number of histories \n\nwill be studied. In order to do that, it will be checked if the simulation time is proportional to \n\nthe number of histories. Simulations with an increase on time will be done and the number of \n\nparticles checked. Then, the statistical uncertainty will be also studied. In that case, it will be \n\nchosen the minimal simulation time to obtain results with acceptable statistical uncertainties, \n\nwhich is a parameter connected to the number of particles.  \n\nThe energy of the electrons in the electron gun is another parameter that has to be \n\nstudied. The nominal energy was for all simulations 6MV, but for the initial energy simulations \n\nwith energies between 5.4 MeV and 6.26 MeV were made. The best value of initial energy is \n\nthe one that the PDD curves simulated and obtained are most coincident. The beam \n\ndivergence, energy FWHM and focal spot FWHM also suffer changes in their values. Although \n\nthese parameters are related to S1, the three segments have to be simulated in order to check \n\nthe results. This happens because only the last simulation segment gives curves that can be \n\ncompared with the ones from the LINAC. \n\nAs nominal energy was constant for all simulations the variance reduction techniques \n\ndoes not suffer many alterations. The variance reduction technique splitting roulette is more \n\n\n\n33 \n \n\nefficient to low energies simulations (above 15 MeV) when compared to rotational splitting \n\n[57]. Thus, as the only energy used in simulations was 6 MeV the variance reduction technique \n\nused was always splitting roulette with the parameters suggested in the PRIMO\u2019s user manual \n\nfor the example of a Varian Clinac 2100 simulation [57]. \n\nTo validate PRIMO software the coincidence of the lateral profiles simulated and \n\nacquired in practice must exist. This step is not as easy as the coincidence between PDD \n\ncurves. In PDD curves the parameter that most affects the result is the energy of the beam, but \n\nin lateral profiles this question is not so obvious. Lateral profiles will be affected by factors that \n\nare not directly connected to the first simulation segment (S1). Parameters controlled in S2 \n\nand S3, as field dimensions and visualization grid of dose distributions, respectively, have a \n\nmajor importance in this question. Therefore, the field dimension must be confirmed, which \n\nwas 10 cm x 10 cm for all simulations made in this work. If penumbra regions where coincident \n\nthe fields have the same size. The size is confirmed by the position of the penumbra region in \n\nthe position axis. However, dose distribution simulation grid controlled in S3, in the voxels \n\ndimensions, can affect this result. Consequently, some grids should be tried in order to obtain \n\nthe best coincidence between lateral profiles. All of these simulations were made using a \n\nwater phantom in S3, which the voxels size and number of primary histories will be optimized \n\nto obtain statistical uncertainties below 2% in suitable calculation time. \n\nWhen this process is finished, PRIMO software is validated and more complex \n\nsimulations can be done.  \n\n \n\n3.4 PRIMO output problem \n \n\nThe PRIMO output is shown in the program as images and graphs. However, the data is \n\nnot easily accessible using other programs. The only file that is exportable to other programs is \n\na text file with all the values generated by PRIMO. As this document is not easy to understand, \n\ninterpret the file and convert it into an image is imperative. This transformation is important to \n\ncompare PRIMO output with data from other programs or practical data, which is a big goal in \n\nthis project. \n\nIn addition to the fact that the output document can be of complex interpretation, \n\ncomparing to other programs than PRIMO, it can present two layouts according to the \n\nsimulation type. If the simulation is with a water tank phantom the data organization is \n\ndifferent than if the simulation were with a slab phantom CT (the one used in practical \n\n\n\n34 \n \n\nmeasurements). This situation complicates the output data conversion to other programs, \n\nsuch as Verisoft from PTW Freiburg.  \n\nTo solve this problem a set of Matlab functions was created (Appendix A). They have as \n\nfinal objective to manipulate the PRIMO output in order to create dose images at specific \n\nlocations in DICOM format, independently of the data output type. For a simple field, i.e. only \n\none field no matter its configuration, this task is not much difficult. The output data is read by \n\na Matlab function and converted into a matrix for a given depth (or for a given value of x or z, \n\naccordingly to the final goal). Then, this matrix is transformed into a dicom image which can be \n\nintroduced in Verisoft to be compared with another image from TPS or from LINAC.  \n\nHowever, if the simulation contains more than one field, this process of conversion \n\nneeds more steps. Thereby, before convert PRIMO data into a matrix, a merge of all fields \n\nmust be done, for a given depth. In order to achieve that, a weighted mean of all fields is \n\nmade. This transforms the data from several fields in data with similar structure of the initially \n\nobtained from one field. After that, the procedure is the same used to one field: convert data \n\ninto a matrix and transform it in a dicom image.  \n\n \n\n3.5 Quality Assurance (QA) Test \n \n\nA verification of the dose distribution to be administered to the patient in an IMRT \n\ntreatment needs to be performed by physicist for every treatment plan. This procedure is \n\nmade using quality control software, such as PTW-Verisoft. Thereby, after being completed the \n\ntreatment plan the physicists will verify if the plan (adapted to a water phantom) is coincident \n\nwith the measurements on the phantom. This comparison is made based on the gamma index \n\ntest. When the distribution dose profiles simulated and measured have a compatibility higher \n\nthan 95%, with a gamma index to 3% and 3mm, the treatment is approved and administered \n\nto the patient. Otherwise is necessary to find what was wrong and redo the QA. In this part of \n\nthe work, the same thing will be done, with the addition of PRIMO output comparison. \n\nAfter performed simulations in PRIMO, the same irradiation set-up will be calculated \n\nin TPS in order to be scheduled and sent to the equipment to be applied. Then, practical \n\nmeasurements on the LINAC will be acquired using the same set-up of QA tests for IMRT \n\ntreatments. A phantom of 30 cm x 30 cm x 15 cm is placed on the top of the bed. The phantom \n\nis made of a material with similar physical properties to the water, in this case the slabs are the \n\nPTW RW3, which have an epoxy resin coverage. There are 4 slabs of 1 cm and 1 slab of 0.2 cm \n\nabove the detectors (Figure 3.9) and 10 slabs beside them. Between the slabs is placed a PTW \n\n\n\n35 \n \n\nOctavius\n? \n\nI (RW3729 array) (Figure 3.10). This is a 27 x 27 cm\n2\n matrix with 729 ionization \n\nchambers that will obtain de dose distributions.  \n\n \n\n \n\nFigure 3.9 \u2013 Solid water phantom used in IMRT treatments quality control in Porto IPO being mounted on the LINAC \ntable for a verification procedure. \n\n \n\n \n\nFigure 3.10 \u2013 PTW matrix of 27 x 27 cm\n2\n formed by 729 ionization chambers, spaced by 1 cm, which is used in the \n\nsolid water phantom at IMRT treatments quality control [45]. \n\n \n\n \n\n \n\n\n\n36 \n \n\n3.6 MLC Tests \n \n\nOnce PRIMO is validated the MLC is added. This is crucial to the aim of this project, \n\nsince there is no IMRT without MLC. Thus, MLC tests will be made in order to prove that \n\nPRIMO has potential to simulate IMRT treatments. \n\nAt this stage some tests with MLC will be done, but all of them will have the same \n\nlogistics. A PTW Octavius\n? \n\nI (RW3+729 array) was imaged by a GE LightSpeed CT scan, \n\nintroduced in PRIMO and used as the voxelized phantom. Then, PRIMO simulation is launched \n\nusing the same parameters that validated PRIMO software. The obtained data is converted in \n\ndicom images, using the procedure already exposed in PRIMO output problem. In second place \n\nthe same test is made in TPS and irradiated in a LINAC, using the set-up of IMRT QA tests, \n\nwhich were already described. At last, the three results are compared using Verisoft, to see if \n\nthey are compatible according to gamma test. This procedure is made for every MLC test, \n\nbefore proceed to the next one. \n\nThe first test made was to see the influence of MLC addition in simulations with an \n\nopen field. The same MLC present in the LINAC was selected in PRIMO without any \n\nconfiguration, i.e., maintaining an open field of 10 x 10 cm\n2\n. In the institute, the LINACs 2300 \n\nhave an MLC of type Millenium 120 MLC, which was used in simulation. After that, the same \n\nconfiguration was used in TPS calculation and was irradiated in a LINAC. \n\nKeeping the same MLC, the second test consists in adding a configuration to it. This \n\nrepresents an irradiation of a static field. The configuration was chosen in order to test both \n\nsides of MLC leaves. Therefore, some leaves staid opened and others closed, as represented in \n\nFigure 3.11. \n\nAfter validation of static MLC, the most important step for this project can be done: a \n\ntest with dynamic MLC. This will be the concept proof that PRIMO can potentially be used to \n\nverify IMRT treatments. At this stage, a dynamic IMRT plan was calculated by the Eclipse\u2122 TPS \n\nand irradiated. Based on this plan, a dynamic MLC delivery was split into 89 static segments \n\nand simulated on solid water phantom as reported in Figure 3.12 and Figure 3.13. The dynamic \n\nIMRT plan was delivered on a solid water phantom, in the same condition of the routinely \n\nQuality Assurance (QA) measurements: solid water phantom centered and positioned at SSD \n\n95 cm with the 729 array placed at 5 cm of depth in the phantom.  This represents the \n\nirradiation of one IMRT field in a LINAC, when is used the step and shoot technique. \n\n\n\n37 \n \n\nGiven the matrix design, which has 1 cm spaces between ionization chambers, it was \n\nused also gafchromic for the last test. This would assure the compatibility or not between the \n\nthree images, since its spatial resolution is better than the one associated to the matrix. \n\n \n\n \n\nFigure 3.11 \u2013 MLC static configuration. \n\n \n\nFigure 3.12 \u2013 Example of Dynamic IMRT divided into 89 static MLC shaped fields. \n\n\n\n38 \n \n\n \n\nFigure 3.13 \u2013 Simulation Setup. The red mark indicates the isocenter placed at the center of the ion chamber array. \nThe isocenter is at 100 cm distance from the beam source. The numerical voxelized phantom is created by the \ninternal conversion tool of PRIMO, once the CT scan calibration curve is introduced. \n\n  \n\n\n\n39 \n \n\n4 Results and Discussion \n \n\n4.1 Basic Dosimetry Curves Analysis \n \n\nEvery six months, LINAC tests using water tank are performed to verify PDD curve, \n\nlateral profiles and other parameters. The curves obtained in these tests are the ones used in \n\nPRIMO comparisons, for validation purposes. However, over the years many curves were \n\nobtained from these verifications. Thus, a study about them had to be made in other to choose \n\nthe best curves to use in PRIMO validation. Thinking in PDD curves, it is obvious that from \n\nthose measurements is not possible distinguish the maximum value, since the curve is made by \n\ndiscrete points. Thus, the maximum value of these PDD curves has to be calculated according \n\nto the methodology already presented in the previous chapter.  From calculations of the curve \n\nthat best fits the maximum PDD curve points it was obtained, for every curve analyzed, a three \n\ndegree polynomial equation. Calculating the first derivative, the zeros are obtained and \n\nconsequently the depth of the maximum dose for that set of points, which is one of the zeros. \n\nIn Figure 4.1 the points calculated and given by Mephysto are shown and the differences are \n\nvisible. R100 from Mephysto and R100 adjusted oscillate around a midline and they are limited \n\nby a margin of 2?, which means twice the standard deviation (k = 2; Prob(2?) = 95.4%). The \n\nvalues suffer variations that seem to be random over time, not being possible to distinguish \n\nany trend.  \n\nAll values are in the considered range, but some of them are near the borders. The \n\nfirst values of R100 and R100 adjusted are the most compatible and they are in the middle \n\nline. All the other values suffer variations in relation to each other. Although in the end they \n\ntend to the first value, the one from commissioning, because LINACs are adjusted when out of \n\nthe limits in accordance to those values. \n\n \n\n\n\n40 \n \n\n \n\nFigure 4.1 - Maximum dose depth. \n\n \n\nRegarding to the lateral profiles x and y a variation in the values of flatness and \n\nsymmetry also occurs. This variation occurs between the calculated and Mephysto values as \n\nwell as between the symmetry and flatness values over time. This fact can be observed in \n\nFigure 4.2 and Figure 4.3 for lateral profile X; in Figure 4.4 and Figure 4.5 the variations in \n\nlateral profile Y. The differences among calculated and Mephysto values are explained for the \n\nexpressions used to calculate the data, since the expressions used in the program are \n\nunknown. However, the variations over time in flatness and symmetry calculated and from \n\nMephysto are the same. Similarly to what occurs with PDDs the changes over time are random \n\naround a central middle line. Although, the values increase and decrease over the years always \n\ntending for the values from commissioning.   \n\nAfter this analysis of the PDD curves and lateral profiles over the years, the data \n\nchosen for simulations comparison were the ones from commissioning. They were selected \n\nbecause the reference for adjustments that LINAC suffers over time and data analyzed proves \n\nthis fact. \n\n \n\n0 \n\n2 \n\n4 \n\n6 \n\n8 \n\n10 \n\n12 \n\n14 \n\n16 \n\n18 \n\n20 \n\n0 5 10 15 \n\nDepth of the Maximum Dose \n\nR100 (Mephysto) \n\nR100 Adjusted \n\nMean value \n\nMinimum value \n\nMaximum value \n\n\n\n41 \n \n\n \n\nFigure 4.2 \u2013 Flatness over the years for lateral profile X. \n\n \n\n \n\nFigure 4.3 \u2013 Symmetry over the years for lateral profile X. \n\n0 \n\n0,5 \n\n1 \n\n1,5 \n\n2 \n\n2,5 \n\n3 \n\n0 2 4 6 8 \n\nF\nla\n\ntn\ne\n\nss\n %\n\n \n\nMoments of measurments over time \n\nFlatness over time \n\nFlatness \n\nFlatness (mephysto) \n\n0 \n\n0,1 \n\n0,2 \n\n0,3 \n\n0,4 \n\n0,5 \n\n0,6 \n\n0,7 \n\n0,8 \n\n0,9 \n\n1 \n\n0 2 4 6 8 \n\nS\ny\n\nm\nm\n\ne\ntr\n\ny\n %\n\n \n\nMoments of measurments over time \n\nSymmetry over time \n\nSymmetry \n\nSymmetry (mephysto) \n\n\n\n42 \n \n\n \n\n \n\nFigure 4.4 - Flatness over the years for lateral profile Y. \n\n \n\n \n\nFigure 4.5 - Symmetry over the years for lateral profile Y. \n\n \n\n \n\n0 \n\n0,5 \n\n1 \n\n1,5 \n\n2 \n\n2,5 \n\n3 \n\n0 2 4 6 8 \n\nF\nla\n\ntn\ne\n\nss\n %\n\n \n\nMoments of measurments over time \n\nFlatness over time \n\nFlatness \n\nFlatness (mephysto) \n\n0 \n\n0,1 \n\n0,2 \n\n0,3 \n\n0,4 \n\n0,5 \n\n0,6 \n\n0,7 \n\n0,8 \n\n0,9 \n\n1 \n\n0 2 4 6 8 \n\nS\ny\n\nm\nm\n\ne\ntr\n\ny\n %\n\n \n\nMoments of measurments over time \n\nSymmetry over time \n\nSymmetry \n\nSymmetry (mephysto) \n\n\n\n43 \n \n\n4.2 PRIMO validation \n \n\nThe validation of PRIMO requires the study of many parameters, in order to \n\nunderstand how they change the basic dosimetry curves simulated by the program. The first \n\nparameter to be studied was the number of histories. First of all, the relationship between the \n\nnumber of histories and simulation time should be optimized. After running several \n\nsimulations with different time lengths, a graph with the relationship between the number of \n\nhistories and the simulation time was built. In this graph, shown in Figure 4.6, an increase of \n\nthe histories number can be seen when the simulation time also increases. However, some \n\npoints differ of this linear correlation. This happens because the processor activity influences \n\nthese parameters, meaning that if the computer is running other task while simulation is \n\nrunning, the number of histories will not be the same as if the processor was only doing the \n\nsimulation, considering an equal duration. Sometimes, this question is hard to overcome \n\nbecause the computer software (Windows 7) has some hidden processes running during \n\nMonte Carlo simulations that come from other tasks, which reduces the computer processing \n\ncapacity. For this reason, if a previous number of histories have to be achieved, it is not \n\nconvenient simulation time to be used as stopping criteria. For this purpose it is better to \n\nselect the number of histories instead.  This technique was adopted, but the amount of time \n\nwasted to a given simulation was too big and the results did not show a big difference. In fact, \n\nthey were similar to the ones obtained in simulations based on time. For example, to get a \n\nsimulation with about 1x10\n8\n histories, it would take about a month, which is not reasonable for \n\na project with this dimension. However, for a simulation with a week of duration the obtained \n\nresults were very satisfactory. In this analysis it was perceptible that simulations with a major \n\nnumber of histories had better statistic, i.e., the curves generated were smoother (Figure 4.7). \n\nIt happens that the higher the number of histories, the better the statistics, but only up to a \n\npoint in which the improvement was not noticeable. However, there is no number of histories \n\nthat give an ideal simulation curve, with the less oscillation as possible. Thus, a balance \n\nbetween time consumed and simulation results in statistic terms must be made. Because of \n\nthis, the stopping criteria time was chosen as work method in this task, since it obtained an \n\nacceptable number of histories and consequently a good simulation statistics in a time interval \n\ncontrolled by us. This will bring similar results with a smaller waste of time. To minimize the \n\ninfluence of the hidden processes referred before, and get a number of histories proportional \n\nto the simulation time, the computer should be restarted before launch any simulation. The \n\nproportionality between the number of histories and the correlation of calculated and \n\n\n\n44 \n \n\nmeasured data (based on gamma index) is also studied, as shown in Figure 4.8. As can be seen, \n\nthere is no relation between both variables. The increment of the number of histories \n\ngenerates more points, more statistics, smoother curves, but not necessarily accurate profiles. \n\nThe precision of the profiles is affected by other factors, which will be studied forward.  \n\n \n\n \n\nFigure 4.6 \u2013 Number of histories in function of the simulation time. \n\n0,00E+00 \n\n5,00E+06 \n\n1,00E+07 \n\n1,50E+07 \n\n2,00E+07 \n\n2,50E+07 \n\n0 500000 1000000 1500000 \n\nH\nis\n\nto\nri\n\ne\ns \n\nTime (s) \n\nHistories vs Time \n\nHistories vs Time \n\n\n\n45 \n \n\n \n\nFigure 4.7 \u2013 PDDs from simulations with the same conditions but with different time as stop criteria. A \u2013 PDD from \nsimulation with 1.97 x 10\n\n6\n histories. B \u2013 PDD from simulation with 9.37 x 10\n\n6\n histories. \n\n \n\n\n\n46 \n \n\n \n\nFigure 4.8 \u2013 Percentage of passing points in function of the number of histories. \n\n \n\nThe next parameter to study was the energy of the electrons when they leave the \n\nelectron gun. This is a parameter analyzed through comparison of PDDs calculated and \n\nmeasured on Varian Clinac 2300. In the user's guide it is suggested to use as energy value the \n\n5.4 MeV and that was the initial value used for most simulations. However, the results were \n\nnot the desired ones because the PDDs do not overlap completely, there was always a \n\ndeviation indicating that the energy value of the electrons in the electron gun would be higher. \n\nThereby, the energy of 6.26 MeV was experienced, because it was the energy used in the \n\nexamples on the user\u2019s guide manual. However, from the comparison with the Clinac 2300 \n\nmeasured curves, it was concluded that the energy of the electrons would not be that one, \n\nbecause the calculated PDD was positioned slightly above the measured PDD. Thus, a new \n\nvalue of energy was experienced. In this case it was the 5.9 MeV. Here, the curves were quite \n\ncoincident, but the calculated PDD still appeared to be slightly below the measured one. For \n\nthis reason the procedure was repeated. At this time, the new value of energy tested was 6 \n\nMeV. The comparison between PDD curves calculated and measured on the LINAC were very \n\ncoincident, the most compatible so far. In Figure 4.9 is shown the percentage of passing points \n\nwhen calculated and measured PDD curves were compared in function of the energy. Looking \n\nto this graph it is not possible to clearly distinguish which are the best energies, because for all \n\nthe energies there are percentages of passing points close to 100%, but there were also very \n\nbad results. This study was made by looking directly to every PDD curve obtained. This \n\nhappens because the percentage of compatible values is influenced by other factors than the \n\nelectrons energy, as we have seen previously. For example, in the case of the 6 MeV of energy, \n\n0 \n\n20 \n\n40 \n\n60 \n\n80 \n\n100 \n\n120 \n\n0,00E+00 1,00E+07 2,00E+07 3,00E+07 \n\nP\ne\n\nrc\ne\n\nn\nta\n\ng\ne\n\n (\n%\n\n) \n\nHistories \n\nPercentage of Passing points in \nfunction of the number of histories \n\nPDD (1% and 1mm) \n\n\n\n47 \n \n\nit can be distinguished in the graph a simulation with a percentage of passing points less than \n\n20% and another in which the compatibility between both PDDs is around 100%. This occurred \n\nbecause in one of the simulations, the number of histories was much smaller than in the other. \n\nConsequently, it brings a lower statistics for the calculated PDD and therefore less consistent \n\nresults, even when the simulation parameters are in accordance with the LINAC parameters in \n\nstudy. This change in energy affects essentially the PDD curve, not affecting much the lateral \n\nprofiles. To adjust the lateral profiles, it is necessary to change another parameter in \n\nsimulation S1 step, the focal spot. This change was done but it was observed that if the focal \n\nspot is too big, the lateral profiles lose their shape, showing with a more round shape (Figure \n\n4.10). The best value found for this parameter was 0.1 cm, in which the lateral profiles \n\ncalculated and measured showed the same shape. The energy FWHM and the beam \n\ndivergence also affects the calculated curves, in particular the lateral profiles. After the study \n\nof the variations in these two parameters they were fixed in 0.2 MeV and 1.5 deg, respectively. \n\n \n\n \n\nFigure 4.9 - Percentage of passing points as function of the energy. \n\n \n\n0 \n\n20 \n\n40 \n\n60 \n\n80 \n\n100 \n\n120 \n\n5,2 5,4 5,6 5,8 6 6,2 6,4 \n\nP\ne\n\nrc\ne\n\nn\nta\n\ng\ne\n\n (\n%\n\n) \n\nEnergy (MeV) \n\nPercentage of passing points in \nfunction of Energy \n\nPDD (1% and 1mm) \n\n\n\n48 \n \n\n \nFigure 4.10 \u2013 Illustration of lateral profile variation when increasing focal spot. \n\n \n\nAnother parameter that needs our attention is the Variance Reduction Technique \n\n(VRT), since it affects the simulation results and speed. As these are simulations in whose \n\nnominal energy value remains constant in 6 MV, the VRT used will always be splitting roulette. \n\nThis VRT is more efficient for energies below 15 MV than the rotational splitting option. The \n\nsimulated field length was always the same (10x10 cm\n2\n). As this happens, the option \"fitted to \n\nthe field size\" is chosen, which makes the simulation shorter. For this VRT the splitting factor \n\nparameter must be set, which in the user's guide indicates the value of 200. However, a study \n\naround this variable was performed in order to confirm that this was indeed the best value for \n\nsplitting factor. In Figure 4.11 is shown how the variation of the splitting factor affects the \n\nagreement between the curves in comparison. It can be seen that a higher splitting factor \n\ndoesn\u2019t mean that the correlation between both curves will be higher. As a matter fact, it is \n\npossible to see that the best results occurred, in general, with a splitting factor below 500. \n\nBecause of this, the splitting factor of 200 was maintained to all simulations, as suggested in \n\nthe user\u2019s guide manual, because it gives good results in a good amount of time. \n\n \n\n\n\n49 \n \n\n \n\nFigure 4.11 - Percentage of passing points in function of splitting factor. \n\n \n\nOnce these steps are completed, a PDD quite coincident with those acquired on \n\nClinac 2300, in Porto IPO was achieved (Figure 4.12). But, to validate the software \n\nconfiguration, it is necessary that the simulated and measured lateral profiles are also \n\ncompatible, which did not occur in the first simulations performed (Figure 4.13). Thus, it had to \n\nbe confirmed if the simulated field size was in agreement with the measured field size. That \n\nwas corroborated because the penumbra of both curves was compatible, which means that \n\nthe calculated and measured field dimensions were the same. The differences between the \n\nlateral profiles were more based the umbra, which didn\u2019t present the exactly shape in both \n\ncurves. For this reason it was necessary to check the simulation grids defined in s3, because it \n\nis a parameter that has a big influence in the simulation results, because it can distort the \n\nexamination of the obtained results. Thus, after several tests regarding the phantom setup, the \n\nconformation of Figure 4.14 was used. The main change made in this Setup was to check the \n\nbox \"shift phantom half bin along Z\" and set the \"depth of measurement\" in 10.000 cm. This \n\nstep changed the calculation grid making the previously calculated results well visible after this \n\nalteration. Therefore, curves which were not in agreement previously, making this small \n\nchange became compatible, because the LINAC parameters were already well defined \n\n(according to Clinac 2300) and the calculation grid was properly adjusted. \n\n0 \n\n20 \n\n40 \n\n60 \n\n80 \n\n100 \n\n120 \n\n0 500 1000 1500 2000 2500 \n\nP\ne\n\nrc\ne\n\nn\nta\n\ng\ne\n\n (\n%\n\n) \n\nSplitting Factor \n\nPercentage of passing points in function \nof the splitting factor  \n\nPDD (1% and 1mm) \n\nx (1% and 1mm) \n\ny (1% e 1mm) \n\n\n\n50 \n \n\n \n\nFigure 4.12 - Comparison between Clinac 2300 (DHX5) PDD from 2011 and corresponding PRIMO simulation. The \ngamma function analysis (2%, 2mm) showed that 100% of the points was lower than 1. \n\n \n\nFigure 4.13 - Comparison between Clinac 2300 (DHX5) lateral profile Y from 2011 and corresponding PRIMO \nsimulation. The gamma function analysis (2%, 2mm) showed that 90.54% of the points was lower than 1. \n\n \n\n \n\nFigure 4.14 \u2013 Phantom Setup. \n\n\n\n51 \n \n\nEnding the study of all these parameters, PRIMO software was validated with a \n\nsimulation of 2 weeks that resulted in 8.6x10\n8\n histories simulated using the parameters already \n\nreferred. This simulation generated the PDD presented in Figure 4.15 and the lateral profiles in \n\nFigure 4.16 and Figure 4.17. As can be seen there the curves simulated and measured are \n\nhighly compatible, which makes possible PRIMO validation. These results are also the basis for \n\nall the remaining simulations to be carried out to complete the goals of this work. \n\n \n\n \n\nFigure 4.15 \u2013 Comparison between Clinac 2300 (DHX5) PDD from 2011 and corresponding PRIMO simulation. The \ngamma function analysis (2%, 2mm) showed that 99.66% of the points was lower than 1. \n\n \n\n\n\n52 \n \n\n \n\nFigure 4.16 \u2013 Comparison between Clinac 2300 (DHX5) lateral profile X from 2011 and corresponding PRIMO \nsimulation. The gamma function analysis (2%, 2mm) showed that 100% of the points was lower than 1. \n\n \n\nFigure 4.17 - Comparison between Clinac 2300 (DHX5) lateral profile Y from 2011 and corresponding PRIMO \nsimulation. The gamma function analysis (2%, 2mm) showed that 100% of the points was lower than 1. \n\n\n\n53 \n \n\n4.3 PRIMO output problem \n \n\nThe simulation results made with PRIMO are shown in images and graphs, as can be \n\nseen in Figure 4.18. This output shows a dose distribution with a 10x10 cm\n2\n open field \n\nsimulated by PRIMO, for a given depth. However this output is given with an extension .dat, \n\nwhich means that a note pad document with a list of numbers is created. However, the most \n\ncommon programs used in radiotherapy to analyze these dose distributions does not read files \n\nwith extension dat. or with this kind of data organization. Thus, the study of PRIMO results is a \n\nhard task to do using tools that do not belong to the program. Consequently, the comparison \n\nbetween PRIMO results with data from other programs is also difficult to perform because \n\nPRIMO only compares PDD curves and lateral profiles, but do not compare, for example, an \n\nimage of a open field dose distribution. In the radiotherapy service, the majority of data from \n\nother programs come in dicom images or similar. For this reason, a way to convert the files \n\nfrom PRIMO to dicom images is necessary in order to compare both data and overcome this \n\nproblem. This transformation is made based on Matlab functions, as it was already explained \n\nin Methodology. The process is a little bit complex and long because PRIMO notepad \n\ndocuments showed different data organization when the simulation is made using a CT scan of \n\na slab phantom or a model from a water phantom. To reach these conclusions, it was \n\nnecessary to previously analyze various PRIMO outputs, which are a big time consumer task, \n\nbut an essential step to proceed with this work.  \n\nIn Figure 4.19 is shown the output of PRIMO already converted. Looking to both \n\nimages (Figure 4.18 and Figure 4.19) it can be seen that they are the same image but with a \n\ndifferent color scheme. However, as the image from Figure 4.19 was transformed in a dicom \n\nimage it can be used in comparison tests with other programs as Verisoft or Doselab, which \n\nare used in clinical radiotherapy.  \n\n \n\n\n\n54 \n \n\n \n\nFigure 4.18 \u2013 PRIMO simulation results. \n\n \n\nFigure 4.19 \u2013 Image output created by MATLAB from PRIMO notepad document. \n\n \n\n4.4 MLC Tests \n \n\nFollowing the procedure described in the Methodology for MLC tests, the influence \n\nof the addition of an MLC was checked in an open field simulation. This simulates an \n\nirradiation in a Clinac 2300 with an open field, because the LINAC didn\u2019t have only the jaws but \n\nalso have the MLC and that\u2019s what it is so important to do this test. The simulation performed \n\ndidn\u2019t show relevant differences from simulations with only the jaws present. Thus, the \n\nsimulation performed was also compatible with the dose distribution acquired from a LINAC \n\nirradiation (Figure 4.20), as occurred with the simulation performed without the presence of \n\nthe MLC. The dose distribution of an open field in a Clinac 2300 was also calculated in TPS and \n\ncompared with the simulation in PRIMO (Figure 4.21) and with the irradiation in the LINAC \n\n(Figure 4.22). As expected, the results from the three modalities were compatible between \n\nthem. The PRIMO simulation shown an agreement of 100% with the LINAC irradiation and of \n\n96,7% with TPS, using gamma index in clinical conditions (3%, 3mm). In its turn, the \n\ncomparison between irradiated field and TPS had also an agreement of 100% using the same \n\ncomparison conditions. The purpose of this test was to confirm the compatibility of the three \n\n\n\n55 \n \n\nmodalities, in order to be able to perform more complex tests, once the agreement between \n\nthem was assured for open fields. \n\n \n\n \n\nFigure 4.20 - Comparison between PRIMO simulation and LINAC irradiation of an open field. \n\n \n\n\n\n56 \n \n\n \n\nFigure 4.21 - Comparison between PRIMO simulation and TPS of an open field. \n\n\n\n57 \n \n\n \n\nFigure 4.22- Comparison between TPS and LINAC irradiation of an open field. \n\n \n\nThe next step in this process is to add a conformation to the MLC and perform \n\ncompatibility tests for static fields. In this section will only be discussed one example of a static \n\nfield, since it reflects the results from the other tests performed. This static field was chosen \n\nbecause the MLC leaves present the major variation tested. In this example the field borders \n\nwere tested with close leaves in the top of the field and with open leaves in the opposite \n\nextreme and the remaining field was tested with all types of conformations for the different \n\npairs of MLC leaves. The simulation results from PRIMO were transformed in dicom images \n\nand compared with the same static field irradiation in a Clinac 2300 and with a dose \n\ndistribution from TPS.  In Figure 4.23 is shown the comparison between a static field simulated \n\non PRIMO with the same field calculated with TPS. The comparison result shows a \n\ncompatibility of 98.1%. This comparison was made using the gamma test with DTA of 3 mm \n\nand dose difference of 3 %, which are the criteria used in clinical practice. Looking to this \n\nresult, the fields are in agreement, with compatibility bigger than 95% meaning that the \n\nsimulation made with PRIMO, using Monte Carlo, is in accordance with the dose distribution \n\n\n\n58 \n \n\ncalculated by TPS. In Figure 4.24 the comparison between practical dose distribution and \n\nPRIMO results can be seen. They present an agreement of 100%, which means that the dose \n\ndistribution calculated in PRIMO was the same irradiated by LINAC. Finally, in Figure 4.25 is \n\nshown a comparison between TPS calculation and a LINAC irradiation in order to prove by \n\nclinical means that both modalities have the same dose distribution. These results \n\ndemonstrate that PRIMO works very well in dose distribution calculation for static fields, which \n\nmakes possible to proceed the study, in order to prove the potentiality of PRIMO for IMRT \n\ntreatments verification. At this stage, PRIMO simulation of conventional radiation therapy \n\ntreatments was checked. \n\n \n\n \n\nFigure 4.23 \u2013 Comparison between PRIMO simulation and TPS of a static MLC field. \n\n\n\n59 \n \n\n \n\nFigure 4.24 - Comparison between PRIMO simulation and LINAC irradiation of a static MLC field. \n\n\n\n60 \n \n\n \n\nFigure 4.25 - Comparison between TPS and LINAC irradiation of a static MLC field. \n\n \n\nContinuing this work, it was time to begin the simulation of dynamic fields. This type of \n\nirradiation field intends to represent one IMRT field in step and shoot technique, which the \n\ndose is not uniform. In PRIMO, it is not possible to simulate one field with a non - uniform dose \n\ndistribution. To accomplish this dynamic field it is necessary to simulate the superposition of \n\nseveral fields with different positions of the MLC leaves. In the end of the simulation, a non-\n\nuniform dose distribution is obtained and it is composed by the sum of these 89 fields \n\ncalculated. The same dynamic field simulated was also irradiated by LINAC in the PTW ion \n\nchamber matrix. The obtained results were compared with simulations using Verisoft. \n\nHowever, compatibility between them was hard to obtain and tests with gafchromic films \n\nwere made to confirm dose distribution in the irradiated field. This technique was adopted \n\nsince it is a more accurate way to analyze dose distributions, because gafchromic spatial \n\nresolution is higher than ion chamber matrix spatial resolution. Thus, a gafchromic film was \n\nirradiated with the dynamic field in study (Figure 4.26), and the ion chamber matrix was also \n\nirradiated with the same plan. The comparison of both showed an agreement of 98.8%, using \n\n\n\n61 \n \n\ngamma test with 3%, and 3mm as criteria, the values used in clinical practice (Figure 4.27). \n\nAfter confirming that the dose distribution obtained with gafchromic films and with the matrix \n\nwere compatible, the comparison tests with the matrix were repeated because it is less \n\ncomplicated to obtain and analyze results. When gafchromic is used the film irradiation is \n\nmade in one day, and its analysis just can be done in the day after, adding the fact that \n\ngafchromic films require some care in its use. In its turn, using the PTW matrix, the field is \n\nirradiated and in a few minutes the results can be seen and analyzed, which for this type of \n\nwork is more advantageous since the work scheme doesn\u2019t change. Comparing the data from \n\nPTW matrix with PRIMO simulation, compatibility between both results was not the intended, \n\nrevealing that data normalization has to be done. This normalization was made to the highest \n\ndose value, directly in Verisoft. In Figure 4.28 are the results from this process. The measured \n\nwith the ion chamber matrix and simulated dose distributions show good agreement. The \n\ngamma function analysis (2%, 2mm) showed that 96% of the points were lower than 1, \n\nconfirming that the simulated and experimental data were compatible. With this step was \n\nproved that PRIMO software has potential to be used in IMRT treatments verification, since it \n\nsimulates with a good agreement IMRT fields in the IMRT step and shoot technique. \n\n \n\n \n\nFigure 4.26 \u2013 Gafchromic film after the dynamic field irradiation. \n\n \n\n \n\nFigure 4.27 \u2013 2D Comparison obtained in Doselab between dynamic field measured with a gafchromic film and with \nthe same measurement in ion chamber matrix. The gamma function analysis (3%, 3mm) showed that 98.8% of the \npoints was lower than 1. \n\n\n\n62 \n \n\n \n\nFigure 4.28 \u2013 A - Dose distribution for the dynamic IMRT treatment, measured with ionization chamber array, \nplaced at 100 cm distance from the LINAC head under 5 cm of water equivalent. B \u2013 Dose distribution at the matrix \nfor the simulated dynamic plan. C - Comparison between PRIMO simulation and LINAC irradiation of a dynamic MLC \nfield. \n\n \n\n  \n\n\n\n63 \n \n\n5 Conclusions and Future Work \n \n\nIMRT is a radiation therapy technique that is widely used in Europe biggest \n\nradiotherapy centers. However, many smaller hospitals still not have this technique in their \n\ntreatments, and others are dealing, only at this moment, with their implementation. Thus, \n\nalthough this is no longer a totally new technique, it still has a very great clinical significance. \n\nTherefore, nowadays the need of improving and developing the IMRT technique still exist. \n\nAs mentioned before, IMRT is a conformal therapy technique, highly accurate, that \n\nallows the administration of high doses of radiation to the target volume, while dose is \n\nminimized, very effectively, to normal surrounding tissue.  To achieve this goal, a verification \n\nprocess is necessary before applying the treatment to a patient, in order to confirm if the TPS \n\nplanned treatment and irradiated by LINAC are compatible. This compatibility, which is based \n\non the gamma index at 3% and 3 mm, must be greater than 95%, which does not always occur. \n\nCompleted this preliminary analysis it was concluded that combining Monte Carlo calculations \n\nto the verification process may be a way to reduce cases of non-compatibility. This was the \n\nreason why this project began, using PRIMO software, which is a program that promised to \n\ncalculate dose distributions in a faster and more user friendly way. \n\nAs PRIMO is a recent program, and once it was necessary to validate the LINAC to \n\nsimulate, in the first work phase was unable to test the program in terms of simulation speed \n\n(when comparing it to other programs with the same purpose). However, on PRIMO first \n\nutilization, its user-friendly aspect is evident. Any person with minimal knowledge in \n\ninformatics and MC simulations of a LINAC can perform a simulation, thinking that it is a \n\nprogram very simple to use and very intuitive. After a few times of utilization, it was realized \n\nthat to obtain satisfactory results, it was necessary larger simulation times. However, \n\ncompared to other programs it was concluded that this could be faster and more efficient, \n\nbecause PRIMO creates intermediate phase-space files (PHSP files) in each simulation stage, \n\nwhich could be reused. For example, in a simulation of s1, the reused of a PHSP file save weeks \n\nof simulation. However, until the program validation, simulations would have to be completed, \n\nto be able to identify the best parameters to use as LINAC parameters. \n\nThe software validation was the most time-consuming task in this project, because it \n\nrequired longer simulations. For the obtainment of good statistical results, simulations \n\nperformed in about 2 weeks were need. The validation process was the most time-consuming \n\nalso because, as expected, the default data in PRIMO, for the simulated LINAC (the Clinac \n\n2300), did not have the desired compatibility degree with the IPO device used for comparisons. \n\n\n\n64 \n \n\nFor this reason, a discovery process of ideal parameters ideas begun by a trial error routine. \n\nAfter several simulations and elapsed many time, the ideal parameters to validate the PRIMO \n\nsoftware were found. Thus, a longer simulation was performed with these parameters in order \n\nto be able to use the PHSP file in the following steps, saving the time used in s1 simulations. At \n\nthe end of this first step, it was concluded that PRIMO user-friendly feature made the program \n\nvalidation much easier, giving that parameters influencing dose distributions were quite \n\nexplicit: they were the only parameters that could be altered directly in PRIMO program. All \n\nother parameters that did not influence this task, such as those relating to LINAC construction \n\nare in a PHSP file that the program uses but does not give to the user the option to change. \n\nThis saves time, because no simulations are carried out with alterations that do not directly \n\naffect the dose distribution. Looking to this fact, PRIMO can appear to be a \"closed box\" \n\nprogram, which for a kind of software like this is not an add-value. However, this PHSP files \n\nthat PRIMO launch can be open as a text file and directly changed, avoiding this question of \n\n\"closed box\". In conclusion, this first step, besides validating PRIMO for simulation of the LINAC \n\n2300 present in Porto IPO, also allowed an adaptation and understanding of the program. \n\nIn the second step of the project, MLC validation was performed, through the \n\nsimulation of a field with a static MLC conformation. At this stage, problems in PRIMO results \n\nexportation were found. This situation forced the creation of alternatives to interpreting these \n\nresults, including the creation of various MATLAB functions to read and transform PRIMO \n\nresults in DICOM images. Another issue which is worth highlighting is the fact that PRIMO do \n\nnot had all kind of MLC that could be present in the devices which PRIMO proposes to \n\nsimulate. This is a question that must be taken into account initially, during the first uses of the \n\nprogram, in order to avoid the LINAC validation, and then the desired MLC does not exist in \n\nPRIMO, which requires that the validation process must be started over. Apart from these \n\nissues, this was a quick phase to execute, in which no adversities were found, in terms of \n\ncompatibility between PRIMO simulations, TPS calculations and LINAC irradiation. Ending this \n\nphase, it is concluded that a conventional radiation treatment simulation would be perfectly \n\nperformed using the PRIMO, given the compatibility obtained for static MLC.  \n\nTo complete this work, the simulation of a field using a dynamic MLC was performed. \n\nAs PRIMO was not built with the initial idea of simulate non-conventional radiotherapy \n\ntreatments, this was a more complicated task. For this reason, alternatives that allow going \n\naround this issue had to be found. Since IMRT treatments fall into two categories: the step and \n\nshot (also known as IMRT with MLC in segments) and IMRT with dynamic MLC; it was decided \n\nto focus only on step-and-shoot mode. As this mode not has a continuous irradiation, it can, in \n\ntheory, be simulated quite reliably by PRIMO, even it not being predestined to non-\n\n\n\n65 \n \n\nconventional treatments simulation. The simulation of only one field of this modality is a long-\n\nlasting process due to the amount of MLC position that needs to be acquired in each field. \n\nOnce simulated the IMRT field (in step-and-shoot mode), the comparison between simulation, \n\nTPS and LINAC data was made. After some adjustments and according to a gamma index of 3% \n\nand 3mm (which are used in clinical practice), compatibility between the three modalities was \n\nfound. Thus, it was concluded that PRIMO is able to simulate a complete IMRT treatment, \n\nsince it can simulate a field of IMRT in step-and-shoot mode. Being possible the simulation of \n\nan IMRT treatment, it is also proved that PRIMO can be used in IMRT verification process, but \n\nwith the disadvantage that it is a slower process than the current one. However, for more \n\ncomplex verification cases, this program can be very useful, given that the time to redo the \n\ntreatment plan can be used to perform verification with PRIMO. Thus, it would be possible to \n\nbetter realize if the plan was or not the appropriate, or if the non-compatibility is due to an \n\ninadequate matrix interpolation. \n\nIn the end of this project, it can be concluded that these were preliminary studies in \n\norder to use PRIMO in clinical practice into the future. This Master`s project proved the \n\npotential of PRIMO within IMRT radiotherapy technique (in step-and-shoot mode), but further \n\nwork is required for simulating a complete IMRT treatment of a patient. An important issue \n\nthat should be taken into account, at an earlier stage of testing, would be to perform \n\nsimulations with different field sizes and more variations in MLC position. This wasn\u2019t possible \n\nto achieve, due to the time needed to carry out these tests, and given the time predicted for \n\nthis project realization. In the context of the work developed, it also should be done more \n\ndynamic field simulations, with a big variety of conformations, which was not made due to the \n\nreasons already explained. \n\nTo continue this work from here, I leave as suggestion the simulation of various IMRT \n\ntreatment fields of a patient (in step-and-shoot mode), using their CT and subsequent \n\ncomparison with data from TPS and LINAC. This way, it will be effectively verified an IMRT \n\ntreatment, proving not only the program potential for this purpose, but its present \n\nimplementation. Another suggestion, a bit more complex, would be the simulation of IMRT \n\ntreatments with dynamic MLC. Subsequently, the simulation of VMAT, another radiotherapy \n\ntreatment technique, would be easier to perform, which would be a big step in MC simulation \n\nof non-conventional treatments. However, this is a work that, if being developed, will need \n\nmany more tests and also some imagination to circumvent some program issues derived from \n\nits user-friendly feature, which is presented to the user as a kind of \"closed box\". \n\nAs understood with this essay, PRIMO software presents a great potential in MC \n\nsimulations field. Combine this software with IMRT treatments, which are one of the most \n\n\n\n66 \n \n\nrevolutionary radiotherapy techniques, could only end as an innovative idea, which brought \n\nnew topics of discussion to this investigation field. Proving this fact, a communication coming \n\nfrom this master thesis was presented in ESTRO 35, one of the most important conferences in \n\nradiotherapy around the world, organized by the European Society for Radiotherapy &amp; \n\nOncology (ESTRO). \n\n  \n\n\n\n67 \n \n\nBibliography \n\n[1] K. Chao, S. Apisarnthanarax, and G. Ozyigit, Practical Essentials of Intensity Modulated \nRadiation Therapy. Lippincott Williams &amp; Wilkins, 2005. \n\n[2] L. Veldeman, I. Madani, F. Hulstaert, G. O. De Meerleer, M. Mareel, and W. De Neve, \n\u201cEvidence behind use of intensity-modulated radiotherapy: a systematic review of \ncomparative clinical studies.,\u201d Lancet Oncol, vol. 9, no. 4, pp. 367\u201375, 2008. \n\n[3] S. I. Gutiontov, E. J. Shin, B. Lok, N. Y. Lee, and R. Cabanillas, \u201cIntensity-modulated \nradiotherapy for head and neck surgeons,\u201d Wiley Online Libr., vol. 119, no. 6, pp. 377\u2013\n382, 2015. \n\n[4] P. C. Williams, \u201cIMRT: Delivery techniques and quality assurance,\u201d Br. J. Radiol., vol. 76, \nno. 911, pp. 766\u2013776, 2003. \n\n[5] A. Mesbahi, A. J. Reilly, and D. I. Thwaites, \u201cDevelopment and commissioning of a \nMonte Carlo photon beam model for Varian Clinac 2100EX linear accelerator,\u201d Appl. \nRadiat. Isot., vol. 64, no. 6, pp. 656\u2013662, 2006. \n\n[6] R. Capote, R. Jeraj, C.-M. Ma, D. W. O. Rogers, F. S\u00e1nchez-Doblado, J. Sempau, J. \nSeuntjens, and J. V. Siebers, \u201cPhase-Space Database for External Beam Radiotherapy,\u201d \nVienna, 2006. \n\n[7] M. A. Cort\u00e9s-Giraldo, J. M. Quesada, M. I. Gallardo, and R. Capote, \u201cAn implementation \nto read and write IAEA phase-space files in GEANT4-based simulations,\u201d Int. J. Radiat. \nBiol., vol. 88, no. 1\u20132, pp. 200\u2013208, 2012. \n\n[8] L. Brualla, M. Rodriguez, and J. Sempau, \u201cPRIMO Project,\u201d 2013. [Online]. Available: \nhttps://www.primoproject.net/primo/. \n\n[9] J. Pope, Medical Physics: Imaging. Oxford: Heinemann Educational Publishers, 1999. \n\n[10] P. Mayles, A. Nahum, and J. C. Rosenwald, Handbook of radiotherapy physics: theory \nand practice. Taylor &amp; Francis Group, 2007. \n\n[11] E. B. Podgorsak, Radiation Oncology Physics: A Handbook for Teachers and Students. \nVienna: IAEA, 2005. \n\n[12] J. M. Michalski, C. A. Perez, and J. A. Purdy, \u201cThree-Dimensional Conformal Radiation \nTherapy (3DCRT) for Prostate Cancer,\u201d The Prostate Cancer InfoLink, 1996. [Online]. \nAvailable: http://www.phoenix5.org/Infolink/Michalski/Part2.html. [Accessed: 26-Jun-\n\n\n\n68 \n \n\n2015]. \n\n[13] \u201cLinear Accelerator,\u201d RadiologyInfo.org, 2013. [Online]. Available: \nhttp://www.radiologyinfo.org/en/info.cfm?pg=linac. [Accessed: 23-Jun-2015]. \n\n[14] ICRP, \u201cICRP 103: The 2007 Recommendations of the International Commission on \nRadiological Protection,\u201d Ann. ICRP, vol. 37, p. 330, 2007. \n\n[15] J. Izewska and G. Rajan, Review of Radiation Oncology Physics: A Handbook for Teachers \nand Students; Chapter 3 - RADIATION DOSIMETERS. IAEA, 2012. \n\n[16] PTW, \u201cPTW Farmer\u00ae Ionization Chambers.\u201d [Online]. Available: \nhttp://www.ptw.de/farmer_chambers0.html. [Accessed: 13-May-2016]. \n\n[17] M. C. Lopes, \u201cUm s\u00e9culo de terapia com radia\u00e7\u00e3o,\u201d Gaz. F\u00edsica, vol. 30, no. 14, pp. 14\u2013\n29, 2005. \n\n[18] \u201cMP3-M,\u201d PTW. [Online]. Available: http://www.ptw.de/2038.html. [Accessed: 05-Apr-\n2016]. \n\n[19] F. M. Khan, The Physics of Radiation Therapy, 3rd ed. 2003. \n\n[20] E. E. Klein, J. Hanley, J. Bayouth, F.-F. Yin, W. Simon, S. Dresser, C. Serago, F. Aguirre, L. \nMa, B. Arjomandy, C. Liu, C. Sandin, and T. Holmes, \u201cTask Group 142 report: quality \nassurance of medical accelerators.,\u201d Med. Phys., vol. 36, no. 9, pp. 4197\u20134212, 2009. \n\n[21] A. Taylor and M. E. B. Powell, \u201cIntensity-modulated radiotherapy - What is it?,\u201d Cancer \nImaging, vol. 4, pp. 68\u201373, 2004. \n\n[22] T. S. Hong, M. a Ritter, W. a Tom\u00e9, and P. M. Harari, \u201cIntensity-modulated radiation \ntherapy: emerging cancer treatment technology.,\u201d Br. J. Cancer, vol. 92, pp. 1819\u20131824, \n2005. \n\n[23] M. T. Milano, L. S. Constine, and P. Okunieff, \u201cNormal Tissue Tolerance Dose Metrics for \nRadiation Therapy of Major Organs,\u201d Semin. Radiat. Oncol., vol. 17, pp. 131\u2013140, 2007. \n\n[24] T. Bortfeld, \u201cIMRT: a review and preview.,\u201d Phys. Med. Biol., vol. 51, no. 13, pp. R363\u2013\nR379, 2006. \n\n[25] M. Alber, S. Broggi, C. De Wagter, I. Eichwurzel, P. Engstr\u00f6m, C. Fiorino, D. Georg, G. \nHartmann, T. Kn\u00f6\u00f6s, A. Leal, H. Marijnissen, B. Mijnheer, M. Paiusco, F. S\u00e1nchez-\n\n\n\n69 \n \n\nDoblado, R. Schmidt, M. Tomsej, and H. Welleweerd, GUIDELINES FOR THE \nVERIFICATION OF IMRT. Brussels, 2008. \n\n[26] L. Gomes, \u201cEstudo dosim\u00e9trico comparativo do Acuros \u00ae XB \u2013 Algoritmo Avan\u00e7ado de \nC\u00e1lculo de dose com o AAA \u2013 Anisotropic Analytical Alghorithm , em tratamentos de \nRadioterapia Externa com a t\u00e9cnica de RapidArc \n\nTM\n Estudo dosim\u00e9trico comparativo do \n\nAcuros \u00ae XB \u2013 Algori,\u201d Escola Superior de Tecnologia da Sa\u00fade de Lisboa, 2013. \n\n[27] M. Scorsetti, A. Fogliata, B. Castiglioni, C. Bressi, M. Bignardi, P. Navarria, P. Mancuso, L. \nCozzi, F. Alongi, and A. Santoro, \u201cEarly clinical experience with volumetric modulated \narc therapy in head and neck cancer patients,\u201d Radiat. Oncol., 2010. \n\n[28] K. Otto, \u201cVolumetric Modulated Arc Therapy: IMRT in a single arc,\u201d Med. Phys., vol. 35, \npp. 310\u2013317, 2008. \n\n[29] N. A. Detorie, \u201cHelical Tomotherapy: A New Tool for Radiation Therapy,\u201d J. Am. Coll. \nRadiol., vol. 5, no. 1, pp. 63\u201366, 2014. \n\n[30] C. X. Yu and G. Tang, \u201cIntensity-modulated arc therapy: principles, technologies and \nclinical implementation,\u201d Phys. Med. Biol., vol. 56, 2011. \n\n[31] G. MacLennan, \u201cPrecision Therapy Acronym Soup: SRS, SRT, SBRT, SAbR,\u201d 2015. \n[Online]. Available: http://www.grayden.info/precision-therapy-acronym-soup-srs-srt-\nsbrt-sabr.html. [Accessed: 06-Apr-2016]. \n\n[32] \u201cRadiation Therapy for Cancer,\u201d National Cancer Institute, 2010. [Online]. Available: \nhttp://www.cancer.gov/about-cancer/treatment/types/radiation-therapy/radiation-\nfact-sheet. [Accessed: 25-Jun-2015]. \n\n[33] S. Goyal and T. Kataria, \u201cImage Guidance in Radiation Therapy: Techniques and \nApplications,\u201d Radiol. Res. Pract., vol. 2014, pp. 1\u201310, 2014. \n\n[34] S. Noda, T. Lautenschlaeger, M. R. Siedow, D. R. Patel, A. El-Jawahri, Y. Suzuki, J. S. \nLoeffler, M. R. Bussiere, and A. Chakravarti, \u201cTechnological advances in radiation \noncology for central nervous system tumors.,\u201d Semin. Radiat. Oncol., vol. 19, no. 3, pp. \n179\u2013186, 2009. \n\n[35] Commissioning and Quality Assurance of Computerized Planning Systems for Radiation \nTreatment of Cancer. Austria, 2004. \n\n[36] D. Hinckley, \u201cPrescribing, recording and reporting photon beam therapy (ICRU report \n50),\u201d ICRU Rep., no. September, pp. 357\u2013360, 1993. \n\n\n\n70 \n \n\n[37] \u201cEclipse\nTM\n\n Treatment Planning System,\u201d Varian. [Online]. Available: \nhttps://www.varian.com/oncology/products/software/treatment-planning/eclipse. \n\n[38] M. G. Carolan, \u201cPencil Beam Dose Calculation Algorithm,\u201d 2010. \n\n[39] I. M. Gagn\u00e9 and S. Zavgorodni, \u201cEvaluation of the analytical anisotropic algorithm in an \nextreme water-lung interface phantom using Monte Carlo dose calculations,\u201d J. Appl. \nClin. Med. Phys., vol. 8, no. 1, pp. 33\u201346, 2007. \n\n[40] A. S\u00e1, \u201cCompara\u00e7\u00e3o entre o pencil beam convolution algorithm e o analytical \nanisotropic algorithm em tumores de mama,\u201d 2013. \n\n[41] NCI, \u201cThe National Cancer Institute Guidelines for the Use of Intensity-Modulated \nRadiation Therapy in Clinical Trials.\u201d \n\n[42] A. W. Beavis, \u201cIs tomotherapy the future of IMRT?,\u201d Br. J. Radiol., vol. 77, pp. 285\u2013295, \n2004. \n\n[43] C. da S. Barros, \u201cEstudo, avalia\u00e7\u00e3o e optimiza\u00e7\u00e3o em Radioterapia - IMRT,\u201d Lisboa Univ. \nNov. Lisboa, 2010. \n\n[44] A. L. D. S. Carvalho, \u201cImplementa\u00e7\u00e3o de um sistema de dos\u00edmetria \u2018in-vivo\u2019 em \nRadioterapia Externa \u2013 aplica\u00e7\u00e3o no cancro da mama,\u201d Minho, 2009. \n\n[45] PTW, \u201cOCTAVIUS\u00ae 729.\u201d [Online]. Available: \nhttp://www.ptw.de/3099.html?&amp;cId=3498. [Accessed: 29-Jun-2015]. \n\n[46] J. Seco and F. Verhaegen, Monte Carlo Techniques in Radiation Therapy. Taylor &amp; \nFrancis, 2013. \n\n[47] M. H. Kalos and P. a. Whitlock, Monte Carlo Methods. 2008. \n\n[48] F. Salvat, J. Fern\u00e1ndez-Varea, and J. Sempau, PENELOPE-2006: A code system for Monte \nCarlo simulation of electron and photon transport, no. 6416. 2006. \n\n[49] R. Panait, I. Butuc, C. Constantin, M. Grivole, and D. Mihailescu, \u201cMonte Carlo codes for \nuse in medical radiation physics,\u201d Lucr. \u00een Ext. \n\n[50] L. Livermore, A. Bielajew, C. Hartmann-Siantar, I. Kawrakow, P. J. Keall, C.-M. Ma, A. \nNahum, F. Salvat, and M. C. White, \u201cMONTE CARLO TRANSPORT IN RADIOTHERAPY - \nCURRENT STATUS AND PROSPECTS , AND PHYSICAL DATA NEEDS,\u201d no. 8, 2000. \n\n\n\n71 \n \n\n[51] L. A. V. Quino, C. I. H. Hernandez, N. Papanikolaou, A. Gutierrez, C. Esquivel, T. Eng, M. \nManciu, and S. Stathakis, \u201cA Monte Carlo model for independent dose verification in \nIMRT and VMAT for the Varian Novalis TX with high definition MLC,\u201d Int. J. Cancer Ther. \nOncol., vol. 3, no. 3, pp. 1\u20137, 2015. \n\n[52] T. Goetzfried, M. Rickhey, M. Treutwein, O. Koelbl, and L. Bogner, \u201cMonte Carlo \nsimulations to replace film dosimetry in IMRT verification.,\u201d Z. Med. Phys., vol. 21, no. 1, \npp. 19\u201325, 2011. \n\n[53] M. F. Belosi, M. Rodriguez, A. Fogliata, L. Cozzi, J. Sempau, A. Clivio, G. Nicolini, E. \nVanetti, H. Krauss, C. Khamphan, P. Fenoglietto, J. Puxeu, D. Fedele, P. Mancosu, and L. \nBrualla, \u201cMonte Carlo simulation of TrueBeam flattening-filter-free beams using varian \nphase-space files: comparison with experimental data.,\u201d Med. Phys., vol. 41, no. 2013, \np. 051707, 2014. \n\n[54] J. Sempau, A. Badal, and L. Brualla, \u201cA PENELOPE-based system for the automated \nMonte Carlo simulation of clinacs and voxelized geometries\u2014application to far-from-\naxis fields,\u201d Med. Phys., vol. 38, no. 2011, p. 5887, 2011. \n\n[55] M. Rodriguez, J. Sempau, and L. Brualla, \u201cPRIMO: A graphical environment for the \nMonte Carlo simulation of Varian and Elekta linacs,\u201d Strahlenther Onkol, vol. 189, pp. \n881\u2013886, 2013. \n\n[56] D. a Low and J. F. Dempsey, \u201cEvaluation of the gamma dose distribution comparison \nmethod.,\u201d Med. Phys., vol. 30, pp. 2455\u20132464, 2003. \n\n[57] L. Brualla, M. Rodriguez, and J. Sempau, PRIMO User \u2019 s Manual. 2014. \n\n[58] T. Depuydt, A. Van Esch, and D. P. Huyskens, \u201cA quantitative evaluation of IMRT dose \ndistributions: Refinement and clinical assessment of the gamma evaluation,\u201d Radiother. \nOncol., vol. 62, pp. 309\u2013319, 2002. \n\n[59] Mephysto, \u201cAppendix D?: Analysis Parameters for Photon Depth Dose Curves.\u201d 2014. \n\n[60] Mephysto, \u201cAppendix B?: Analysis Parameters for Profiles.\u201d 2014. \n\n   \n\n\n\n \n\n \n\n \n\n \n\n \n\nAppendices \n  \n\n\n\nii \n \n\nAppendix A \n \n\nIn Appendix A is presented all the Matlab functions used to transform PRIMO output in DICOM \n\nimages. These functions also allow the sum of several fields, if needed, building one IMRT field.  \n\n \n\nA.1.  Functions to write a new PRIMO file \n \n\n%Function to write new PRIMO File \n\n \n\nfunction WritePRIMOFile(inputAddressList, WeightList, outputAddress, \n\nWhichIsLast, selection) \n\n  \nswitch selection \n    case 'CT' \n        [MatMedia, Voxels, VoxelsDim, VoxelsPos, nParticlesSum] = \n\nReadPRIMOAllFileCT(WhichIsLast, inputAddressList, WeightList); \n    case 'Box' \n        [MatMedia, Voxels, VoxelsDim, VoxelsPos, nParticlesSum] = \n\nReadPRIMOAllFile(WhichIsLast, inputAddressList, WeightList); \n    otherwise \n        error('invalid selection') \nend \n\n  \nfid = fopen(outputAddress,'wt'); \n\n  \nswitch selection \n    case 'CT' \n        SavePhantomFileCT(MatMedia, Voxels, VoxelsPos, VoxelsDim, \n\nnParticlesSum, WhichIsLast, fid); \n    case 'Box' \n        SavePhantomFile(MatMedia, Voxels, VoxelsPos, VoxelsDim, \n\nnParticlesSum, WhichIsLast, fid); \n    otherwise \n        error('invalid selection') \nend \n\n  \nfclose(fid); \n\n \n\n%Function to write PRIMO File Header \n\n \n\nfunction WritePRIMOFileHeader(Voxels, MinValues, BinWidths, fid) \n\n  \nfprintf(fid, '%s\\n', \n\n'#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>'); \nfprintf(fid, '%s\\n', '# [SECTION REPORT SPATIAL DOSE DISTRIB]'); \nfprintf(fid, '%s\\n', '# Dose units are: eV/g per history'); \nfprintf(fid, '%s\\n', '# No. of bins in x,y,z directions:'); \nfprintf(fid, '#  %d %d %d\\n', Voxels); \nfprintf(fid, '%s\\n', '# Min values and bin widths for x,y,z(cm):'); \nfprintf(fid, '#   %7.5E  %7.5E  %7.5E  %7.5E  %7.5E  %7.5E\\n', \n\nMinValues(1), BinWidths(1), MinValues(2), BinWidths(2), MinValues(3), \n\nBinWidths(3)); \nfprintf(fid, '%s\\n', '#'); \n\n\n\niii \n \n\nfprintf(fid, '%s\\n', '# For plotting purposes, two values per bin \n\ncoordinate are given, namely,'); \nfprintf(fid, '%s\\n', '#   the low end and the middle point of each \n\nbin'); \nfprintf(fid, '%s\\n', '#'); \nfprintf(fid, '%s', '# xBinIndex : xLow(cm) : xMiddle(cm) : yBinIndex : \n\nyLow(cm) : yMiddle(cm) : zBinIndex : zLow(cm) : zMiddle(cm) : dose : \n\n+-2sigma'); \n\n \n\n%Function to write PRIMO File Footer \n\n \n\nfunction WritePRIMOFileFooter(nParticles, WhichIsLast, fid) \n\n  \nfprintf(fid, '\\n\\n\\n'); \n\n  \nif WhichIsLast~=0 \n    fprintf(fid, '# Performance report\\n'); \n    fprintf(fid, '#   Random seeds:\\n'); \n    fprintf(fid, '#   1\\n'); \n    fprintf(fid, '#   2\\n'); \n    fprintf(fid, '#   No. of histories simulated [N]:\\n'); \n    fprintf(fid, '#              %d\\n', nParticles); \n    fprintf(fid, '#   CPU time [t] (s):\\n'); \n    fprintf(fid, '#    4.40843E+02\\n'); \n    fprintf(fid, '#   Speed (histories/s):\\n'); \n    fprintf(fid, '#    1.04991E+03\\n'); \n    fprintf(fid, '#   Average uncertainty (above 1/2 max score) in %% \n\n[uncert]:\\n'); \n    fprintf(fid, '#    1.70386E+02\\n'); \n    fprintf(fid, '#   Intrinsic efficiency [N*uncert^2]^-1:\\n'); \n    fprintf(fid, '#    7.44211E-11\\n'); \n    fprintf(fid, '#   Absolute efficiency [t*uncert^2]^-1:\\n'); \n    fprintf(fid, '#    7.81352E-08\\n'); \n    fprintf(fid, '#\\n'); \nend \n\n  \nWritePRIMOFile2ndFooter(nParticles, fid); \n\n \n\n%Function to write PRIMO File Second Footer \n\n \n\nfunction WritePRIMOFile2ndFooter(nParticles, fid) \n\n  \nfprintf(fid, '#\\n'); \nfprintf(fid, '# The dose was integrated from NNN parallel simulation \n\nprocesses.\\n#\\n#\\n#\\n'); \nfprintf(fid, '# Final performance report\\n'); \nfprintf(fid, '#   No. of histories simulated [N]:\\n'); \nfprintf(fid, '#           %d\\n', nParticles); \nfprintf(fid, '#   Speed (histories/s):\\n'); \nfprintf(fid, '#      12509.07\\n'); \nfprintf(fid, '#   Average uncertainty (above 1/2 max score) in %% \n\n[uncert]:\\n'); \nfprintf(fid, '#      38.561\\n'); \nfprintf(fid, '#   Intrinsic efficiency [N*uncert^2]^-1:\\n'); \nfprintf(fid, '#      1.20287E-010\\n'); \nfprintf(fid, '#   Absolute efficiency [t*uncert^2]^-1:\\n'); \n\n\n\niv \n \n\nfprintf(fid, '#      1.50468E-006\\n#\\n'); \nfprintf(fid, '# Have a nice day.\\n'); \n\n \n\nA.2. Functions to read and interpret PRIMO files using a slab phantom \n\nin the simulation \n \n\n%Function to read PRIMO complete File \n\n \n\nfunction [MatMedia, Voxels, VoxelsDim, VoxelsPos, nParticlesSum] = \n\nReadPRIMOAllFile(WhichIsLast, inputAddressList, WeightList) \n\n  \nMatsList = cell(size(inputAddressList)); \nHeadersList = cell(size(inputAddressList)); \nFootersList = cell(size(inputAddressList)); \n\n  \nnParticleList = zeros(size(inputAddressList)); \n\n  \nS = size(MatsList); \n\n  \nVoxels = [0, 0, 0]; \nVoxelTest = [0 0 0]; \n\n  \nVoxelsDim = [0, 0, 0]; \nVoxelsDimTest = [0 0 0]; \n\n  \nVoxelsPos = [0, 0, 0]; \nVoxelsPosTest = [0 0 0]; \n\n  \nWeightSum = 0; \nnParticlesSum = 0; \nFactorSum = 0; \n\n  \nfor ii=1:1:S(2) \n\n     \n    sprintf('\\nReading Field %d\\n', ii) \n\n     \n    if WhichIsLast==0 \n        [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFile(char(inputAddressList(ii)), 1); \n    else \n        if ii~=WhichIsLast \n            [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFile(char(inputAddressList(ii)), 1); \n        else \n            [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFile(char(inputAddressList(ii)), 0); \n        end \n    end \n\n     \n    sprintf('\\nEnd Reading Field %d\\n\\n', ii) \n\n     \n    if ii==1 \n        MatMedia = zeros(Voxels(1)*Voxels(2)*Voxels(3), 11, 'double'); \n        for nn=1:1:9 \n            MatMedia(:, nn) = Mat(:, nn); \n        end \n    end \n\n\n\nv \n \n\n     \n    if ii==1 \n        VoxelTest = Voxels; \n        VoxelsDimTest = VoxelsDim; \n        VoxelsPosTest = VoxelsPos; \n    else \n        if ((isequal(Voxels, VoxelTest) == 0) || (isequal(VoxelsDim, \n\nVoxelsDimTest) == 0) || (isequal(VoxelsPos, VoxelsPosTest) == 0)); \n            error('Voxel numbers are different.... Check carefully \n\nyour files!') \n        end \n    end \n    WeightSum = WeightSum + WeightList(ii); \n\n     \n    nParticles; \n\n     \n    nParticleList(ii) = nParticles; \n    nParticlesSum = nParticlesSum + nParticles; \n    FactorSum = FactorSum + WeightList(ii)*nParticles; \n\n     \n    MatMedia = CalculatePRIMOMedia(MatMedia, Mat, nParticleList(ii), \n\nWeightList(ii)); \n\n     \nend \n\n  \nMatMedia(:, 10) = MatMedia(:,10)/FactorSum; \n \n\n \n\n%Function to read PRIMO File (header and footer) \n\n \n\nfunction [MatOut, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFile(inputAddress, islast) \n\n  \nformat shortG \n\n  \nfid = fopen(inputAddress); \n\n  \nLineWith_nVox = 5; \n\n  \nLineWith_VoxDim = 7; \n\n  \nHeaderRows = 12; \n\n  \nVoxels = [0, 0, 0]; \n\n  \n[Voxels, VoxelsDim, VoxelsPos] = ReadHeader(HeaderRows, fid, \n\nLineWith_nVox, LineWith_VoxDim); \n\n  \ndelimiterIn = ' '; \n\n \nMatOut = fscanf(fid, '%d %f %f %d %f %f %d %f %f %f %f', [11 \n\nVoxels(1)*Voxels(2)*Voxels(3)]); \nMatOut = MatOut'; \n\n  \nLineWith_nParticles = 0; \nif islast == 0 \n    LineWith_nParticles = 12; \nelse \n\n\n\nvi \n \n\n    LineWith_nParticles = 29; \nend \n\n  \nFooterRows = 36; \n\n  \nnParticles = 0; \n\n  \nnParticles = ReadFooter(FooterRows, fid, LineWith_nParticles); \n\n  \nfclose(fid); \n\n \n\n%Function to read header \n\n \n\nfunction [Voxels, VoxelsDim, VoxelsPos] = ReadHeader(HeaderRows, fid, \n\nLineWith_nVox, LineWith_VoxDim) \n\n  \nfor ii=1:1:HeaderRows \n    Row = fgetl(fid); \n    if ii==LineWith_nVox \n        Voxels = ReadNumVoxelsFromHeader(Row); \n    end \n\n     \n    if ii==LineWith_VoxDim \n        [VoxelsDim] = ReadVoxelDimFromHeader(Row); \n        [VoxelsPos] = ReadVoxelPosFromHeader(Row); \n    end \nend \n \n\n%Function to read voxel number from header \n\n \n\nfunction [Voxels] = ReadNumVoxelsFromHeader(Row) \n\n  \nS = size(Row); \nRow = strtrim(Row(1,2:S(2))); \nVoxels = str2num(Row); \n\n \n\n%Function to read voxel dimensons from header \n\n \n\nfunction VoxelsDim = ReadVoxelDimFromHeader(Row) \n\n  \nS = size(Row); \nRow = strtrim(Row(1,2:S(2))); \nNum = str2num(Row); \n\n  \nVoxelsDim = [Num(2) Num(4) Num(6)]; \n\n \n\n%Function to read voxel position from header \n\n \n\nfunction VoxelsDim = ReadVoxelPosFromHeader(Row) \n\n  \nS = size(Row); \nRow = strtrim(Row(1,2:S(2))); \n\n\n\nvii \n \n\nNum = str2num(Row); \n\n  \nVoxelsDim = [Num(1) Num(3) Num(5)]; \n\n \n\n%Function to read footer \n\n \n\nfunction [nParticles] = ReadFooter(FooterRows, fid, \n\nLineWith_nParticles) \n\n  \nFooterExt = ''; \n\n  \nfor ii=1:1:FooterRows \n    Row = fgetl(fid); \n   if ii==LineWith_nParticles \n        nParticles = ReadnParticlesFromFooter(Row); \n   end \nend \n\n \n\n \n\n%Function to read number of particles in footer \n\n \n\nfunction [nParticles] = ReadnParticlesFromFooter(Row) \n\n  \nS = size(Row); \nRow = strtrim(Row(1,2:S(2))); \nnParticles = str2num(Row); \n\n \n\n \n\n%Function to calculate PRIMO mean values \n\n \n\nfunction MatMediaOut = CalculatePRIMOMedia(MatMedia, Mat, nParticles, \n\nWeight) \n\n  \nsprintf('\\nSumming up Weighted Matrixes\\n'); \n\n  \nMatMediaOut(:, 10) = MatMedia(:, 10) + (Weight*nParticles)*Mat(:, 10); \nMatMediaOut(:, 11) = 0; \n\n  \nsprintf('\\nMatrixes Summed\\n'); \n\n \n\n \n\n \n%Function to save phantom file \n\n \n\n \nfunction SavePhantomFile(MatMedia, Voxels, VoxelsPos, VoxelsDim, \n\nnParticlesSum, WhichIsLast, fid) \n\n  \nWritePRIMOFileHeader(Voxels, VoxelsPos, VoxelsDim, fid); \n\n  \nMatDose = reshape(MatMedia(:, 10), Voxels); \nMatUncertainty = reshape(MatMedia(:, 11), Voxels); \n\n  \nfor ii=1:1:Voxels(3) \n    for jj=1:1:Voxels(2) \n        for kk=1:1:Voxels(1) \n\n\n\nviii \n \n\n            fprintf(fid, '\\n%d %7.5E %7.5E %d %7.5E %7.5E %d %7.5E \n\n%7.5E %7.5E %7.5E', kk, VoxelsPos(1)+(kk-1)*VoxelsDim(1), \n\nVoxelsPos(1)+(kk-1)*VoxelsDim(1)+VoxelsDim(1)/2, jj, VoxelsPos(2)+(jj-\n\n1)*VoxelsDim(2), VoxelsPos(2)+(jj-1)*VoxelsDim(2)+VoxelsDim(2)/2, ii, \n\nVoxelsPos(3)+(ii-1)*VoxelsDim(3), VoxelsPos(3)+(ii-\n\n1)*VoxelsDim(3)+VoxelsDim(3)/2, MatDose(kk, jj, ii), \n\nMatUncertainty(kk, jj, ii)); \n        end \n        fprintf(fid, '\\n'); \n    end \nend \n\n  \nWritePRIMOFileFooter(nParticlesSum, WhichIsLast, fid); \n\n \n\n \n\n \n%Function to create image \n\n \n\nfunction CreateImageFromBox(inputAddress, filter, selection, \n\ninputmetadata, islast, saveAddress) \n\n  \n[MatIn, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFile(inputAddress, islast); \n\n  \nVoxels \nVoxelsDim \nVoxelsPos \nnParticles \n\n  \nMatOut = zeros(VoxelsDim(1)*VoxelsDim(2)*VoxelsDim(3), 11); \n\n  \nx = zeros(Voxels(1)); \ny = zeros(Voxels(2)); \nz = zeros(Voxels(3)); \n\n  \nfor ii=1:1:Voxels(1) \n    x(ii) = VoxelsPos(1) + (ii-1)*VoxelsDim(1); \nend \n\n  \nfor jj=1:1:Voxels(2) \n    y(jj) = VoxelsPos(2) + (jj-1)*VoxelsDim(2); \nend \n\n  \nfor kk=1:1:Voxels(3) \n    z(kk) = VoxelsPos(3) + (kk-1)*VoxelsDim(3); \nend \n\n  \nfor ii=1:1:Voxels(1) \n    for jj=1:1:Voxels(2) \n        for kk=1:1:Voxels(3) \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),1) = ii; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),3) = x(ii) + VoxelsDim(1)/2; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),2) = x(ii); \n\n             \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),4) = jj; \n\n\n\nix \n \n\n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),6) = y(jj) + VoxelsDim(2)/2; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),5) = y(jj); \n\n             \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),7) = kk; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),9) = z(kk) + VoxelsDim(3)/2; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),8) = z(kk); \n\n             \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),10) = MatIn(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2), 10); \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),11) = MatIn(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2), 11); \n        end \n    end \nend \n\n  \nmetadata = load(inputmetadata); \n\n  \nS = size(selection); \n\n  \nfor ii=1:1:S(2) \n    selection(1, ii); \n    switch filter \n        case 'x' \n            MatSelect = \n\nMatOut(double(MatOut(:,3))==double(selection(1, ii)), :); \n            Voxels2D = [1, Voxels(2), Voxels(3)]; \n            metadata.metadata.Rows = Voxels(2); \n            metadata.metadata.Columns = Voxels(3); \n            PixSpac = [VoxelsDim(1) VoxelsDim(2)]; \n            metadata.metadata.Width = Voxels(2); \n            metadata.metadata.Height = Voxels(3); \n        case 'xVoxIndex' \n            MatSelect = MatOut(MatOut(:,1)==selection(1, ii), :); \n            Voxels2D = [1, Voxels(2), Voxels(3)]; \n            metadata.metadata.Rows = Voxels(2); \n            metadata.metadata.Columns = Voxels(3); \n            PixSpac = [VoxelsDim(1) VoxelsDim(2)]; \n            metadata.metadata.Width = Voxels(2); \n            metadata.metadata.Height = Voxels(3); \n        case 'y' \n            MatSelect = \n\nMatOut(double(MatOut(:,6))==double(selection(1, ii)), :); \n            Voxels2D = [Voxels(1), 1, Voxels(3)]; \n            metadata.metadata.Rows = Voxels(1); \n            metadata.metadata.Columns = Voxels(3); \n            PixSpac = [VoxelsDim(3) VoxelsDim(1)]; \n            metadata.metadata.Width = Voxels(1); \n            metadata.metadata.Height = Voxels(3); \n        case 'yVoxIndex' \n            MatSelect = MatOut(MatOut(:,4)==selection(1, ii), :); \n            Voxels2D = [Voxels(1), 1, Voxels(3)]; \n            metadata.metadata.Rows = Voxels(1); \n            metadata.metadata.Columns = Voxels(3); \n\n\n\nx \n \n\n            PixSpac = [VoxelsDim(3) VoxelsDim(1)]; \n            metadata.metadata.Width = Voxels(1); \n            metadata.metadata.Height = Voxels(3); \n        case 'z' \n            MatSelect = \n\nMatOut(double(MatOut(:,9))==double(selection(1, ii)), :); \n            Voxels2D = [Voxels(1), Voxels(2), 1]; \n            metadata.metadata.Rows = Voxels(1); \n            metadata.metadata.Columns = Voxels(2); \n            PixSpac = [VoxelsDim(2) VoxelsDim(1)]; \n            metadata.metadata.Width = Voxels(1); \n            metadata.metadata.Height = Voxels(2); \n        case 'zVoxIndex' \n            MatSelect = MatOut(MatOut(:,7)==selection(1, ii), :); \n            Voxels2D = [Voxels(1), Voxels(2), 1]; \n            metadata.metadata.Rows = Voxels(1); \n            metadata.metadata.Columns = Voxels(2); \n            PixSpac = [VoxelsDim(2) VoxelsDim(1)]; \n            metadata.metadata.Width = Voxels(1); \n            metadata.metadata.Height = Voxels(2); \n        otherwise \n            error('invalid selection') \n    end \n\n  \n    str = strcat(saveAddress, sprintf('_%d.dcm', selection(ii))) \n    metadata.metadata.Filename = str; \n\n  \n    MatSelect = squeeze(reshape(MatSelect(:,10), Voxels2D)); \n\n     \n    dicomwrite(imrotate(MatSelect, -90), str, metadata, 'CreateMode', \n\n'Copy', 'PixelSpacing', 10*PixSpac, 'SOPClassUID', \n\n'1.2.840.10008.5.1.4.1.1.2', 'MultiframeSingleFile', true); \nend \n\n \n\n \n\nA.2. Functions to read and interpret PRIMO files using a CT image in the \n\nsimulation \n \n\n%Function to read PRIMO complete File  \n\n \n\nfunction [MatMedia, Voxels, VoxelsDim, VoxelsPos, nParticlesSum] = \n\nReadPRIMOAllFileCT(WhichIsLast, inputAddressList, WeightList) \n\n  \nnParticleList = zeros(size(inputAddressList)); \n\n  \nS = size(inputAddressList) \n\n  \nVoxels = [0, 0, 0]; \nVoxelTest = [0 0 0]; \n\n  \nVoxelsDim = [0, 0, 0]; \nVoxelsDimTest = [0 0 0]; \n\n  \nVoxelsPos = [0, 0, 0]; \nVoxelsPosTest = [0 0 0]; \n\n  \nWeightSum = 0; \n\n\n\nxi \n \n\nnParticlesSum = 0; \nFactorSum = 0; \n\n  \nfor ii=1:1:S(2) \n\n     \n    sprintf('\\nReading Field %d\\n', ii) \n\n     \n    if WhichIsLast==0 \n        [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFileCT(char(inputAddressList(ii)), 1); \n    else \n        if ii~=WhichIsLast \n            [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFileCT(char(inputAddressList(ii)), 1); \n        else \n            [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFileCT(char(inputAddressList(ii)), 0); \n        end \n    end \n\n     \n    sprintf('\\nEnd Reading Field %d\\n\\n', ii) \n\n     \n    if ii==1 \n        MatMedia = zeros(Voxels(1)*Voxels(2)*Voxels(3), 11, 'double'); \n        for nn=1:1:9 \n            MatMedia(:, nn) = Mat(:, nn); \n        end \n    end \n\n     \n    if ii==1 \n        VoxelTest = Voxels; \n        VoxelsDimTest = VoxelsDim; \n        VoxelsPosTest = VoxelsPos; \n    else \n        if ((isequal(Voxels, VoxelTest) == 0) || (isequal(VoxelsDim, \n\nVoxelsDimTest) == 0) || (isequal(VoxelsPos, VoxelsPosTest) == 0)); \n            error('Voxel numbers are different.... Check carefully \n\nyour files!') \n        end \n    end \n    WeightSum = WeightSum + WeightList(ii); \n\n     \n    nParticles; \n\n     \n    nParticleList(ii) = nParticles; \n    nParticlesSum = nParticlesSum + nParticles; \n    FactorSum = FactorSum + WeightList(ii)*nParticles; \n\n     \n    MatMedia = CalculatePRIMOMediaCT(MatMedia, Mat, nParticleList(ii), \n\nWeightList(ii)); \n\n     \nend \n\n  \nMatMedia(:, 10) = MatMedia(:,10)/FactorSum; \n\n \n\n \n%Function to read PRIMO File (header and footer) \n\n \n\n\n\nxii \n \n\nfunction [MatOut, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFileCT(inputAddress, islast) \n\n  \nformat shortG \n\n  \nfid = fopen(inputAddress); \n\n  \nLineWith_nVox = 8; \n\n  \nLineWith_VoxelDim = 10; \n\n  \nHeaderRows = 11; \n\n  \n[Voxels, VoxelsDim, VoxelsPos] = ReadHeaderCT(HeaderRows, fid, \n\nLineWith_nVox, LineWith_VoxelDim); \n\n  \nVoxels \nVoxelsDim \nVoxelsPos \n\n  \nMatOut = zeros(Voxels(1)*Voxels(2)*Voxels(3), 11, 'double'); \n\n  \nfor kk=1:1:Voxels(3) \n    [zVoxIndex middleZ] = ReadCTsingleVoxLine(fid); \n    for jj=1:1:Voxels(2) \n        [yVoxIndex middleY] = ReadCTsingleVoxLine(fid); \n        for ii=1:1:Voxels(1) \n            index = ii + Voxels(1)*(jj -1) + Voxels(1)*Voxels(2)*(kk-\n\n1); \n            MatOut(index, 1) = ii; \n            MatOut(index, 2) = VoxelsPos(1) - VoxelsDim(1)/2 + (ii - \n\n1)*VoxelsDim(1); \n            MatOut(index, 3) = MatOut(index, 2) + VoxelsDim(1)/2; \n            MatOut(index, 4) = jj; \n            MatOut(index, 5) = middleY - VoxelsDim(2)/2; \n            MatOut(index, 6) = middleY; \n            MatOut(index, 7) = kk; \n            MatOut(index, 8) = middleZ - VoxelsDim(3)/2; \n            MatOut(index, 9) = middleZ; \n            MatOut(index, 10) = fscanf(fid, '%f', 1); \n            MatOut(index, 11) = fscanf(fid, '%f', 1); \n        end \n        fscanf(fid, '\\n'); \n    end \n    fscanf(fid, '\\n'); \nend \n\n  \nLineWith_nParticles = 0; \nif islast == 0 \n    FooterRows = 18; \n    LineWith_nParticles = 8; \nelse \n    FooterRows = 35; \n    LineWith_nParticles = 25; \nend \n\n  \nnParticles = 0; \n\n  \nnParticles = ReadFooterCT(FooterRows, fid, LineWith_nParticles); \n\n\n\nxiii \n \n\n  \nnParticles \n\n  \nfclose(fid); \n\n \n\n \n\n%Function to read header \n\n \n\nfunction [Voxels, VoxelsDim, VoxelsPos] = ReadHeaderCT(HeaderRows, \n\nfid, LineWith_nVox, LineWith_VoxDim) \n\n  \nfor ii=1:1:HeaderRows \n    Row = fgetl(fid); \n\n     \n    if ii==LineWith_nVox \n        Voxels = ReadNumVoxelsFromHeaderCT(Row); \n    end \n\n     \n    if ii==LineWith_VoxDim \n        VoxelsDim = ReadVoxelDimFromHeaderCT(Row); \n    end \nend \n\n  \nposition = ftell(fid); \n\n  \nRow = fgetl(fid); \n[Values count] = ReadVoxelzPosFromHeaderCT(Row); \nVoxelsPos(3) = Values(1) - VoxelsDim(3)/2; \n\n  \nRow = fgetl(fid); \n[Values count] = ReadVoxelyPosFromHeaderCT(Row); \nVoxelsPos(2) = Values(1) - VoxelsDim(2)/2; \n\n  \nVoxelsPos(1) = -Voxels(1)*VoxelsDim(1)/2 +VoxelsDim(1)/2; \n\n  \nVoxels; \nVoxelsDim; \nVoxelsPos; \n\n  \nfseek(fid, position, 'bof'); \n\n \n\n \n%Function to read voxel number from header \n\n \n\nfunction [Voxels] = ReadNumVoxelsFromHeaderCT(Row) \n\n  \nS = size(Row); \nRow = strtrim(Row(1,2:S(2))); \nVoxels = str2num(Row); \n\n \n\n%Function to read voxel dimensons from header \n\n \n\nfunction [VoxelsDim] = ReadVoxelDimFromHeaderCT(Row) \n\n  \nS = size(Row); \nRow = strtrim(Row(1,2:S(2))); \n\n\n\nxiv \n \n\nVoxelsDim = str2num(Row); \n\n \n\n%Function to read voxel position in y from header \n\n \n\nfunction [index VoxelsPos] = ReadVoxelyPosFromHeaderCT(Row) \n\n  \n[index VoxelsPos] = sscanf(Row, '# yVoxIndex=%d yMiddle(cm)= %f'); \n\n \n\n \n\n%Function to read voxel position in z from header \n\n \n\nfunction [index VoxelsPos] = ReadVoxelzPosFromHeaderCT(Row) \n\n  \n[index VoxelsPos] = sscanf(Row, '# zVoxIndex=%d zMiddle(cm)= %f'); \n\n \n\n \n\n%Function to read footer \n\n \n\nfunction [nParticles] = ReadFooterCT(FooterRows, fid, \n\nLineWith_nParticles) \n\n  \nFooterRows; \nLineWith_nParticles; \n\n  \nFooterExt = ''; \n\n  \nfor ii=1:1:FooterRows \n    Row = fgetl(fid); \n   if ii==LineWith_nParticles \n       nParticles = ReadnParticlesFromFooter(Row); \n   end \nend \n\n \n\n \n%Function to read number of particles in footer \n\n \nfunction [nParticles] = ReadnParticlesFromFooter(Row) \n\n  \nS = size(Row); \nRow = strtrim(Row(1,2:S(2))); \nnParticles = str2num(Row); \n\n \n\n \n%Function to calculate PRIMO mean values \n\n \nfunction MatMediaOut = CalculatePRIMOMediaCT(MatMedia, Mat, \n\nnParticles, Weight) \n\n  \nsprintf('\\nSumming up Weighted Matrixes\\n'); \n\n  \nMatMediaOut(:, 10) = MatMedia(:, 10) + (Weight*nParticles)*Mat(:, 10); \nMatMediaOut(:, 11) = 0; \n\n  \nsprintf('\\nMatrixes Summed\\n'); \n\n \n\n\n\nxv \n \n\n \n%Function to save phantom file \n\n \n\nfunction SavePhantomFileCT(MatMedia, Voxels, VoxelsPos, VoxelsDim, \n\nnParticlesSum, WhichIsLast, fid) \n\n  \nWritePRIMOFileHeader(Voxels, VoxelsPos, VoxelsDim, fid); \n\n  \nMatDose = reshape(MatMedia(:, 10), Voxels); \nMatUncertainty = reshape(MatMedia(:, 11), Voxels); \n\n  \nfor ii=1:1:Voxels(3) \n    for jj=1:1:Voxels(2) \n        for kk=1:1:Voxels(1) \n            fprintf(fid, '\\n%d %7.5E %7.5E %d %7.5E %7.5E %d %7.5E \n\n%7.5E %7.5E %7.5E', kk, VoxelsPos(1)+(kk-1)*VoxelsDim(1), \n\nVoxelsPos(1)+(kk-1)*VoxelsDim(1)+VoxelsDim(1)/2, jj, VoxelsPos(2)+(jj-\n\n1)*VoxelsDim(2), VoxelsPos(2)+(jj-1)*VoxelsDim(2)+VoxelsDim(2)/2, ii, \n\nVoxelsPos(3)+(ii-1)*VoxelsDim(3), VoxelsPos(3)+(ii-\n\n1)*VoxelsDim(3)+VoxelsDim(3)/2, MatDose(kk, jj, ii), \n\nMatUncertainty(kk, jj, ii)); \n        end \n        fprintf(fid, '\\n'); \n    end \nend \n\n  \nWritePRIMOFileFooter(nParticlesSum, WhichIsLast, fid); \n\n \n \n\n%Function to create image \n\n \n\nfunction CreateImageFromCT(inputAddress, filter, selection, \n\ninputmetadata, islast, saveAddress) \n\n  \n[MatIn, Voxels, VoxelsDim, VoxelsPos, nParticles] = \n\nReadPRIMOFileCT(inputAddress, islast); \n\n  \nVoxels \nVoxelsDim \nVoxelsPos \nnParticles \n\n  \nMatOut = zeros(VoxelsDim(1)*VoxelsDim(2)*VoxelsDim(3), 11); \n\n  \nx = zeros(Voxels(1)); \ny = zeros(Voxels(2)); \nz = zeros(Voxels(3)); \n\n  \nfor ii=1:1:Voxels(1) \n    x(ii) = VoxelsPos(1) + (ii-1)*VoxelsDim(1); \nend \n\n  \nfor jj=1:1:Voxels(2) \n    y(jj) = VoxelsPos(2) + (jj-1)*VoxelsDim(2); \nend \n\n  \nfor kk=1:1:Voxels(3) \n    z(kk) = VoxelsPos(3) + (kk-1)*VoxelsDim(3); \nend \n\n\n\nxvi \n \n\n  \nfor ii=1:1:Voxels(1) \n    for jj=1:1:Voxels(2) \n        for kk=1:1:Voxels(3) \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),1) = ii; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),3) = x(ii) + VoxelsDim(1)/2; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),2) = x(ii); \n\n             \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),4) = jj; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),6) = y(jj) + VoxelsDim(2)/2; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),5) = y(jj); \n\n             \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),7) = kk; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),9) = z(kk) + VoxelsDim(3)/2; \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),8) = z(kk); \n\n             \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),10) = MatIn(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2), 1); \n            MatOut(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2),11) = MatIn(ii + (jj-1)*Voxels(1) + (kk-\n\n1)*Voxels(1)*Voxels(2), 2); \n        end \n    end \nend \n\n  \nmetadata = load(inputmetadata); \n\n  \nswitch filter \n    case 'x' \n        MatSelect = MatOut(double(MatOut(:,3))==double(selection), :); \n        Voxels2D = [1, Voxels(2), Voxels(3)]; \n        metadata.metadata.Rows = Voxels(2); \n        metadata.metadata.Columns = Voxels(3); \n        PixSpac = [VoxelsDim(1) VoxelsDim(2)]; \n        metadata.metadata.Width = Voxels(2); \n        metadata.metadata.Height = Voxels(3); \n    case 'xVoxIndex' \n        MatSelect = MatOut(MatOut(:,1)==selection, :); \n        Voxels2D = [1, Voxels(2), Voxels(3)]; \n        metadata.metadata.Rows = Voxels(2); \n        metadata.metadata.Columns = Voxels(3); \n        PixSpac = [VoxelsDim(1) VoxelsDim(2)]; \n        metadata.metadata.Width = Voxels(2); \n        metadata.metadata.Height = Voxels(3); \n    case 'y' \n        MatSelect = MatOut(double(MatOut(:,6))==double(selection), :); \n        Voxels2D = [Voxels(1), 1, Voxels(3)]; \n        metadata.metadata.Rows = Voxels(1); \n        metadata.metadata.Columns = Voxels(3); \n        PixSpac = [VoxelsDim(3) VoxelsDim(1)]; \n\n\n\nxvii \n \n\n        metadata.metadata.Width = Voxels(1); \n        metadata.metadata.Height = Voxels(3); \n    case 'yVoxIndex' \n        MatSelect = MatOut(MatOut(:,4)==selection, :); \n        Voxels2D = [Voxels(1), 1, Voxels(3)]; \n        metadata.metadata.Rows = Voxels(1); \n        metadata.metadata.Columns = Voxels(3); \n        PixSpac = [VoxelsDim(3) VoxelsDim(1)]; \n        metadata.metadata.Width = Voxels(1); \n        metadata.metadata.Height = Voxels(3); \n    case 'z' \n        MatSelect = MatOut(double(MatOut(:,9))==double(selection), :); \n        Voxels2D = [Voxels(1), Voxels(2), 1]; \n        metadata.metadata.Rows = Voxels(1); \n        metadata.metadata.Columns = Voxels(2); \n        PixSpac = [VoxelsDim(2) VoxelsDim(1)]; \n        metadata.metadata.Width = Voxels(1); \n        metadata.metadata.Height = Voxels(2); \n    case 'zVoxIndex' \n        MatSelect = MatOut(MatOut(:,7)==selection, :); \n        Voxels2D = [Voxels(1), Voxels(2), 1]; \n        metadata.metadata.Rows = Voxels(1); \n        metadata.metadata.Columns = Voxels(2); \n        PixSpac = [VoxelsDim(2) VoxelsDim(1)]; \n        metadata.metadata.Width = Voxels(1); \n        metadata.metadata.Height = Voxels(2); \n    otherwise \n        error('invalid selection') \nend \n\n  \nmetadata.metadata.Filename = inputAddress; \n\n  \nsize(MatSelect) \n\n  \nMatSelect = reshape(MatSelect(:,10), Voxels2D); \ndicomwrite(imrotate(MatSelect, -90), saveAddress, metadata, \n\n'CreateMode', 'Copy', 'PixelSpacing', 10*PixSpac, 'SOPClassUID', \n\n'1.2.840.10008.5.1.4.1.1.2', 'MultiframeSingleFile', true);"}]}}}